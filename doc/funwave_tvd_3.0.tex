\documentclass[11pt]{article}

\usepackage{times}
\usepackage{amsbsy}

\usepackage{geometry}                % See geometry.pdf to learn the layout options. There are lots.
\geometry{letterpaper}                   % ... or a4paper or a5paper or ... 
%\geometry{landscape}                % Activate for for rotated page geometry
%\usepackage[parfill]{parskip}    % Activate to begin paragraphs with an empty line rather than an indent
\usepackage{graphicx}
\usepackage{amssymb}
\usepackage{epstopdf}
\usepackage{url}
\usepackage{color}

\DeclareGraphicsRule{.tif}{png}{.png}{`convert #1 `dirname #1`/`basename #1 .tif`.png}

\newcommand{\be}{\begin{equation}}
\newcommand{\ee}{\end{equation}}
  
\newcommand{\beq}{\begin{eqnarray}}
\newcommand{\eeq}{\end{eqnarray}}
\newcommand{\ba}{\begin{eqnarray}}
\newcommand{\ea}{\end{eqnarray}}

\newcommand{\ua}{{\bf u}_\alpha}
\newcommand{\utwo}{\overline{\bf u}_2}


\newcommand{\ubar}{\overline{u}}
\newcommand{\vbar}{\overline{v}}
\newcommand{\phis}{{\phi}^{*}}
\newcommand{\thetas}{{\theta}^{*}}

\title{ {\bf \Huge FUNWAVE-TVD}\\
\vspace{1cm}
Fully Nonlinear Boussinesq Wave Model with TVD Solver \\
Documentation and User's Manual \\
{\bf (Version 3.0)} \\ 
Release Dec 2016
}
%\author{Fengyan Shi,  James T. Kirby, Babak Tehranirad \\
%Center for Applied Coastal Research, University of Delaware, Newark, DE 19716\\
%Jeffrey C. Harris and Stephan Grilli \\
%Department of Ocean Engineering, University of Rhode Island, Narragansett, RI 02882}


\date{}   
                                   
\begin{document}

\maketitle

{\bf Fengyan Shi}, Center for Applied Coastal Research, University of Delaware 

{\bf James T. Kirby}, Center for Applied Coastal Research, University of Delaware

{\bf Babak Tehranirad}, Center for Applied Coastal Research, University of Delaware

{\bf Jeffrey C. Harris},  Department of Ocean Engineering, University of Rhode Island,

\vspace*{0.5cm}
Guest authors

{\bf Young-Kwang Choi}, Korea Institute of Ocean Science and Technology

{\bf Matt Malej},  U.S. Army Engineer Research and Development Center


\vspace*{2.2cm}
     

\begin{figure}[htbp]
\centering
\includegraphics[width=1.0\textwidth]{./figures/CACR_cover.pdf}
%\caption{Solitary wave calculated in a larger domain Grid\_A (upper) and in a nested smaller domain Grid\_B (lower) at t=100s, 200s, 300s, and 400s.}
%\label{nesting}
\end{figure}

%\begin{center}
%{\Large 
%Center for Applied Coastal Research \\ University of Delaware \\
%Research Report NO. CACR-11-03}
%\end{center}     
\thispagestyle{empty}

\newpage
\begin{center}{\bf \Large Acknowledgements}
\end{center}

\vspace*{0.5cm}
  This model development  was a part of the surfzone optics project   sponsored  by  
 the Office of Naval Research, Coastal Geosciences Program through grant N00014-10-1-0088. 
 The work of wave runup benchmark tests 
was sponsored by the National Tsunami Hazard Mitigation Program(NTHMP). 

Special thanks to  Drs. Seung-Nam Seo and Young-Kwang Choi from Korea Institute of Ocean Science and Technology (KIOST) who conducted line-by-line checking on the code and provided some important revisions on Version 3.0. Some examples were contributed by Drs. Seo and Choi. 

\thispagestyle{empty}

\newpage
\begin{abstract}

The report documents a new version of the fully nonlinear Boussinesq wave model (FUNWAVE) initially developed by Kirby et al. (1998). The development of the present version was motivated by recent needs for modeling of  surfzone-scale optical properties in a Boussinesq model framework,  and  modeling of  Tsunami wave in both a regional/coastal scale for prediction of coastal inundation and a basin scale for wave propagation.  This version  features  several theoretical and numerical improvements, including 1) a more complete set of fully nonlinear Boussinesq equations; 2) MUSCL-TVD solver with adaptive Runge-Kutta time stepping; 3) Both viscosity wave breaking scheme and shock-capturing breaking scheme; 4) wetting-drying moving boundary condition with incorporation of HLL construction method into the scheme; 5) an option for parallel computation.  
The documentation provides derivations of the conservation form of theoretical equations, re-arrangement of pressure gradient term in order to obtain a numerically well-balanced form, detailed numerical schemes, users' manual and examples.  Users can also refer to Shi et al. (2012a) for the Cartesian version and Kirby et al. (2012) for the spherical version of the model.  

 The examples in the previous report (Shi et al., 2011)  have been updated using the present version (Version 3.0). This version also includes new examples contributed by Drs. Seung-Nam Seo and Young-Kwang Choi. The tsunami benchmark tests in spherical coordinates are reported separately in Tehranirad et al. (2013). 
 

\end{abstract}

\vspace*{0cm}

{\bf Source code update:} 

 {\color{blue} \url{https://github.com/fengyanshi/FUNWAVE-TVD}}

\thispagestyle{empty}

\newpage

\begin{center} 
 \tableofcontents 
\end{center}

 \newpage
 
 \listoffigures
 
 \newpage
 
 \listoftables
 
 \newpage


%\setcounter{page}{0}
%thispagestyle{empty}

\addcontentsline{toc}{subsection}{}

\newpage

\section*{Differences between Version 1.0 and Version 1.1}

The major updates from FUNWAVE-TVD Version 1.0 to Version 1.1 are new model capabilities in grid nesting, incorporation of wind effect, wave generation in the spherical mode and calculation of time-averaged properties.    Version 1.1 has been fully tested using the existing examples in the previous report for Version 1.0 and  tsunami benchmark tests in spherical coordinates reported by Shi et al. (2012b). Detailed updates are listed below.

\begin{enumerate}

\item One-way grid nesting capability was added in Version 1.1 (subroutine OneWayCoupling). The nesting schemes and an example are shown in section 4 and section 5, respectively. 

\item Wind effect was added based on Chen et al. (2004). Users should specify -DWIND in Makefile in order to use this option.  Details are described in section 4.5.

\item Output of mean velocities.

\item Wavemakers  were added in the spherical mode in order to conduct benchmark tests (Shi et al., 2012b).

\item Coding for VANLEER\_LIMITER () was modified for a better computational efficiency.

\item At a wet-dry interface, water depth at cell interface (DepthX and DepthY) was evaluated using the depth at the cell center of the wet point. This approach can avoid an extreme large value of slope caused by the raw topographic data (e.g., NGDC data). 

\item Bugs were fixed for MASK9 where the previously defined array has a different size from that of U and V.


\end{enumerate}  

\section*{Differences between Version 2.0 and Version 1.1}

The major change from Version 1.1 to Version 2.0 is for the spherical mode. Recently, Kirby et al. (2012) formulated a more complete set of Boussinesq equations in spherical coordinates. The equations include both weakly nonlinear and fully nonlinear forms based on velocities at a reference level $z_\alpha$. In version 2.0, we implemented the weakly nonlinear formulations. Version 2.0 has been fully tested using the existing examples in the previous report for Version 1.0/1.1 and tsunami benchmark tests in spherical coordinates (Shi et al., 2012). Other updates are listed below.

\begin{enumerate}

\item Compared to Version 1.1, a more accurate scheme for grid nesting was implemented. Affected subroutines include PHI\_COLL, CAL\_DISPERSION and GET\_Eta\_U\_V\_HU\_HV.  Boundary conditions for dispersion terms were removed at nesting boundaries (in PHI\_COLL and CAL\_DISPERSION). Boundary conditions at nesting boundaries are added in the tridiagonal solver (GET\_Eta\_U\_V\_HU\_HV). To activate this option, set -DZALPHA in Makefile.

\item The wall clock was added in the main program.

\item Input format for gauges was changed to geographic coordinates (Lat/Lon) in the spherical mode (Version 1.1 and earlier used grid numbers I and J).

\item Several useless subroutines were removed from the code. 

\end{enumerate}

\section*{Differences between Version 2.1 and Version 2.0}

The major change from Version 2.0 to Version 2.1 is for the friction factor specifications. Inside previous versions the model used a fixed friction factor for the whole modeling domain. However, in version 2.1 the model is capable of reading an initial friction field (friction coefficient matrix) that can be defined differently for each grid by the user. Also, the code is now able to use Manning coefficient as well as conventional friction factor. Moreover, output system efficiency is upgraded inside version 2.1 and several variable are added to the recording list of FUNWAVE-TVD. Updates are listed below.


\begin{enumerate}
\item Version 2.1 is capable of reading an input file for friction coefficient for cases in which friction field is not homogeneous.

\item Version 2.1 is able to use Manning coefficient formulation (in addition to friction coefficient formulation) to calculate friction force. To activate this option, set -DMANNING in Makefile.

\item The efficiency of writing the output files is upgraded in this version.

\item In version 2.1, user can print the maximum momentum flux, maximum velocity, and minimum surface elevation as well as maximum vorticity in addition to other output variable in prior versions.


\end{enumerate}

\section*{Differences between Version 2.2 and Version 2.1}

There are some problems found in application of Larsen-Dancy-type (Larsen and Dancy, 1983, Chen et al., 1999) sponge layers for long-term simulations. The direct damping method combined with the TVD scheme  generates sawtooth noises with a $2 dx$ wave length. The sawtooth noises are usually not noticeable due to small magnitudes. However, they grow gradually with time and may become significant in a long term simulation. In Version 2.2, we complemented two additional slope layer methods: the friction-type sponge layer and the viscous-type sponge layer. 

In addition, Version 2.2 added the eddy-viscosity type breaking algorithm (Kennedy et al., 2000).

\section*{Differences between Version 3.0 and Version 2.2}

In Version 3.0, the codes were reorganized into the modular form. Several bugs have been found and fixed (thanks to Young-Kwang Choi's work).  We completely removed the option for the implicit iteration procedure because it is unnecessary based on tests. The periodic boundary condition was implemented in the parallel code using the Sherman-Morrison algorithm. New examples are added. 

\newpage

\section{Introduction}

Boussinesq wave models  have become a useful tool  for modeling surface wave transformation from deep water  to the swash zone, as well as  wave-induced circulation inside the surfzone.  Improvements in the range of model applicability have been obtained with respect to classical restrictions to both weak dispersion and weak nonlinearity.  Madsen et al (1991) and Nwogu (1993) demonstrated that the order of approximation in reproducing frequency dispersion effects could be increased using either judicious choices for the form (or reference point) for Taylor series expansions for the vertical structure of dependent variables, or operators effecting a rearrangement of dispersive terms in already-developed model equations.  These approaches, combined with use either of progressively higher order truncated series expansions (Gobbi et al, 2000;  Agnon et al, 1999) or multiple level representations (Lynett and Liu, 2004), have effectively eliminated the restriction of this class of model to relatively shallow water, allowing for their application to the entire shoaling zone or deeper.  At the same time, the use of so-called "fully-nonlinear" formulations (e.g., Wei et al (1995) and many others) effectively eliminates the restriction to weak nonlinearity by removing the wave height to water depth ratio as a scaling or expansion parameter in the development of approximate governing equations.  This approach has improved model applicability in the surf and swash zones particularly, where surface fluctuations are of the order of mean water depth at least and which can represent the total vertical extent of the water column in swash conditions.  Representations of dissipative wave-breaking events, which do not naturally arise as weak discontinuous solutions in the dispersive Boussinesq formulation, have been developed usually following an eddy viscosity formulation due to Zelt (1991), and have been shown to be highly effective in describing surf zone wave height decay.  The resulting class of models has been shown to be highly effective in modeling wave-averaged surf zone flows over both simple (Chen et al, 2003; Feddersen et al, 2011) and complex (Geiman et al, 2011) bathymetries.  Kim et al (2009) have further extended the formulation to incorporate a consistent representation of boundary layer turbulence effects on vertical flow structure.

Existing approaches to development of numerical implementations for Boussinesq models include a wide range of finite difference, finite volume, or finite element formulations.  In this paper, we describe the development of a new numerical approach for the FUNWAVE model (Kirby et al, 1998), which has been widely used as a public domain open-source code since its initial development.  FUNWAVE was originally developed using an unstaggered finite difference formulation for spatial derivatives together with an iterated 4th order Adams-Bashforth-Moulton (ABM) scheme for time stepping (Wei and Kirby, 1995), applied to the fully nonlinear model equations of Wei et al (1995).  In this scheme, spatial differencing is handled using a mixed-order approach, employing fourth-order accurate centered differences for first derivatives and second-order accurate differences for third derivatives. This choice was made in order to move leading order truncation errors to one order higher  than the $O(\mu^2)$ dispersive terms (where $\mu$ is ratio of a characteristic water depth to a horizontal length, a dimensionless parameter characterizing frequency dispersion), while maintaining the tridiagonal structure of spatial derivatives within time-derivative terms.  This scheme is straightforward to develop and has been widely utilized in other Boussinesq models.  Kennedy et al  (2000) and Chen et al (2000) describe further aspects of the model system aimed at generalizing it for use in modeling surf  zone flows.  Breaking is handled using a generalization to two horizontal dimensions of the eddy viscosity model of Zelt (1991).  Similar approaches have been  used by other Boussinesq model developers, such as Nwogu and Demirbilek (2001), who used a more sophisticated eddy viscosity model in which the eddy viscosity is expressed in terms of turbulent kinetic energy and a length scale. The presence of a moving shoreline in the swash zone is handled using a ``slot'' or porous-beach method, in which the entire domain remains wetted using a network of slots at grid resolution which are narrow but which extend down to a depth lower than the minimum expected excursion of the modelled free surface.  These generalizations form the basis for the existing public domain version of the code (Kirby et al, 1998).  Subsequently, several extensions have been made in research versions of the code.  Kennedy et al (2001) improved nonlinear performance of the model by utilizing an adaptive reference level for vertical series expansions, which is allowed to move up and down with local surface fluctuations.  Chen et al (2003) extended the model to include longshore periodic boundary conditions and described it's application to modeling longshore currents on relatively straight coastlines.  Shi et al (2001) generalized the model coordinate system to non-orthogonal curvilinear coordinates.  Finally, Chen et al (2003) and Chen (2006) provided revised model equations which correct deficiencies in the representation of higher order advection terms, leading to a set of model equations which, in the absence of dissipation effects, conserve depth-integrated potential vorticity to $O(\mu^2)$, consistent with the level of approximation in the model equations.

The need for a new formulation for FUNWAVE arose from recognition of several crucial problems with the existing code.  First, the original model proved to be ``noisy'', or at least weakly unstable to high wavenumbers near the grid Nyquist limit.  In addition, both the implementation of the eddy viscosity model for surf zone wave breaking and the interaction of runup with beach slots proved to be additional sources of noise in model calculations.  In the original unstaggered grid finite difference scheme,  these effects led to the need for periodic application of dissipative filters, with the frequency of filtering increased in areas with active breaking.  The overall grid-based noise generation was found to stem from several sources.  First, Kennedy (2001, personal communications), during development of a High Performance Fortran (HPF) version of the code on an early linux cluster, discovered that the noise was partially due to implementation of boundary conditions and could be alleviated to an extent.  At the same time, the curvilinear model developed by Shi et al (2001) was implemented using a staggered grid for spatial differencing, and the resulting code was found to be less susceptible to the general grid noise problem.  A comparison of noise levels in the original FUNWAVE, the staggered grid scheme of Shi et al, and the corrected boundary condition formulation of Kennedy may be found in Zhen (2004).  

Additional sources of noise related either to the eddy viscosity formulation or interaction between the flow and beach "slots" remain less well analyzed or understood.  In addition, the performance of the slots themselves has been called into question in several cases involving inundation over complex bathymetry.   Slots which are too wide relative to the model grid spacing may admit too much fluid before filling during runup, and cause both a reduction in amplitude and a phase lag in modeled runup events. At the other extreme, slots which are too narrow tend to induce a great deal of numerical noise, leading to the need for intermittent or even fairly frequent filtering of swash zone solutions.   Poor model performance in comparison to data for the case of Swigler and Lynett (2011), described below in the example section, was the determining factor in the decision to pursue a new model formulation.

A number of recently development  Boussinesq-type wave models have used a hybrid method  combining the finite-volume and finite-difference TVD (Total Variation Diminishing)-type schemes (Toro, 2009),  and have shown robust performance of the shock-capturing method in simulating breaking waves and coastal inundation (Tonelli and Petti, 2009, 2010, Roeber et al., 2010, Shiach and Mingham, 2009, Erduran et al., 2005, and others). The use of the hybrid method, in which the underlying components of the nonlinear shallow water equations (which form the basis of the Boussinesq model equations) are handled using the TVD finite volume method while dispersive terms are implemented using conventional finite differencing, provides a robust framework for modeling of surf zone flows.  In particular, wave breaking may be handled entirely by the treatment of weak solutions in the shock-capturing TVD scheme, making the implementation of an explicit formulation for breaking wave dissipation unnecessary.   In addition, shoreline movement may be handled quite naturally as part of the Reiman solver underlying the finite volume scheme.


In this version, we describe the development of a hybrid finite volume - finite difference scheme for the fully nonlinear Boussinesq model equations of Chen (2006), extended to incorporate a moving reference level as in Kennedy et al (2001).  The use of a moving reference elevation  is more consistent with a time-varying representation of elevation at a moving shoreline in modeling of a swash zone dynamics and coastal inundation.  
A conservative form of the equations is derived.  Dispersive terms are reorganized  with the aim of constructing a tridiagonal structure of spatial derivatives within time-derivative terms. The surface elevation gradient term are also rearranged to obtain a numerically well-balanced form, which is suitable for any numerical order.    In contrast to previous  high-order temporal schemes, which usually require uniform time-stepping, we use adaptive time stepping based on a third-order Runge-Kutta method.  
Spatial derivatives are discretized using a combination of finite-volume and finite-difference methods. A high-order MUSCL(Monotone Upstream-centered Schemes for Conservation Laws) reconstruction technique, which is accurate up to the fourth-order,  is used in the Riemann solver.  The wave breaking scheme follows the approach of Tonelli and Petti (2009),  who used the ability of the nonlinear shallow water equations (NLSWE) with a TVD solver to simulate moving hydraulic jumps. Wave breaking is modeled by switching from Boussinesq to NSWE at cells where the Froude number exceeds a certain threshold. The original eddy viscosity breaking scheme is retained in Version 3.0. A  wetting-drying scheme is used to model a moving shoreline. 

The model was parallelized using the domain decomposition technique. The Message Passing Interface (MPI) with non-blocking communication is used for data communication between processors. 


This report  provides derivations of the conservation form of theoretical equations with a well-balanced pressure gradient term, numerical schemes, and users' manual. The last part of report  illustrates the model's applications to  problems of wave breaking and runup  in the context of a standard suite of benchmark tests. 
In addition, we include a documentation of the spherical Boussinesq model used for Tsunami wave simulations.  The spherical Boussinesq model was based on Kirby et al. (2004, 2012) and implemented in the same model framework. 

\section{Theory}


In this section, we describe the development of a set of Boussinesq equations which are accurate to $O(\mu^2)$ in dispersive effects.  Here,  $\mu$ is a parameter characterizing the ratio of water depth to wave length, and is assumed to be small in classical Boussinesq theory.  We retain dimensional forms below but will refer to the apparent $O(\mu^2)$ ordering of terms resulting from deviations from hydrostatic behavior in order to identify these effects as needed.  The model equations used here follow from the work of Chen (2006).  In this and earlier works starting with Nwogu (1993), the horizontal velocity is written as
\be
{\bf u} = {\bf u}_\alpha + {\bf u}_2(z)   \label{eq1}
\ee
Here, ${\bf u}_\alpha$ denotes the velocity at a reference elevation $z=z_\alpha$, and
\be
{\bf u}_2 (z) = (z_\alpha - z) \nabla A + \frac{1}{2} \left( z_\alpha^2 - z^2 \right) \nabla B \label{eq2}
\ee
represents the depth-dependent correction at $O(\mu^2)$, with $A$ and $B$ given by
\ba
A &=& \nabla \cdot (h {\bf u}_\alpha)  \nonumber \\
B &=& \nabla \cdot {\bf u}_\alpha    \label{eq3}
\ea
The derivation follows Chen (2006) except for the additional effect of letting the reference elevation $z_\alpha$ vary in time according to
\be
z_{\alpha} =  \zeta h + \beta \eta \label{eq4}
\ee
where $h$ is local still water depth,  $\eta$ is local surface displacement and $\zeta$ and $\beta$ are constants, as in Kennedy et al (2001).  This addition does not alter the details of the derivation, which are omitted below.

\subsection{Governing equations}

The equations of Chen (2006) extended to incorporate a possible moving reference elevation follow.  The depth-integrated volume conservation equation is given by
\be
\eta_t  +  \nabla \cdot {\bf M} =0  \label{eq5}
\ee
where 
\be
{\bf M}  =  H  \left\{ {\bf u}_\alpha +  \overline{\bf u}_2  \right\}  \label{eq6}
\ee
is the horizontal volume flux.  $H = h + \eta $ is the total local water depth  and $\overline{\bf u}_2$ is the depth averaged $O(\mu^2)$ contribution to the horizontal velocity field, given by
\be
\overline{\bf u}_2 = \frac{1}{H} \int_{-h}^\eta {\bf u}_2(z) dz =  \left(\frac{z_\alpha^2}{2} -\frac{1}{6} (h^2 - h\eta +\eta^2) \right) \nabla B  +  \left( z_\alpha +\frac{1}{2} (h - \eta )\right) \nabla A   \label{eq7}
\ee
The depth-averaged horizontal momentum equation can be written as
\be
 {\bf u}_{\alpha,t} + ({\bf u}_\alpha \cdot \nabla) {\bf u}_\alpha + g \nabla \eta + {\bf V}_{1} +{\bf V}_2+{\bf V}_3 + {\bf R}  = 0  \label{eq8}
\ee
where $g$ is the gravitational acceleration and $ {\bf R}$ represents diffusive and dissipative terms including bottom friction and subgrid lateral turbulent mixing. ${\bf V}_1$ and ${\bf V}_2$  are terms representing the dispersive Boussinesq terms given by 
\ba
{\bf V}_1 &=&  \left\{ \frac{z_\alpha^2}{2} \nabla B + z_{\alpha} \nabla A \right\}_t   - \nabla \left[ \frac{\eta^2}{2} B_{ t } + \eta A_{ t }) \right]   \label{eq9} \\
{\bf V}_2  &= &  \nabla \left \{ (z_\alpha - \eta) ({\bf u}_\alpha \cdot \nabla) A + \frac{1}{2} (z_\alpha^2 - \eta^2) ({\bf u}_\alpha \cdot \nabla) B
 + \frac{1}{2}  [A + \eta B]^2 \right\}   \label{eq10}
\ea
The form of (\ref{eq9}) allows for the reference level $z_\alpha$ to be treated as a time-varying elevation, as suggested in Kennedy et al (2001).  If this extension is neglected, the terms reduce to the form given originally by Wei et al (1995).   The expression (\ref{eq10})  for ${\bf V}_2$ was also given by Wei et al (1995), and is not altered by the choice of a fixed or moving reference elevation.

The term ${\bf V}_3$ in (\ref{eq8}) represents the $O(\mu^2)$ contribution to the expression for {\boldmath$\omega$} $\times {\bf u} = \omega {\bf i}^z \times {\bf u}$ (with ${\bf i}^z$ the unit vector in the $z$ direction) and may be written as
\be
{\bf V}_3 = \omega_0 {\bf i}^z \times \overline{\bf u}_2 + \omega_2 {\bf i}^z  \times {\bf u}_\alpha \label{eq11}
\ee
where
\ba
\omega_0  & = &  (\nabla \times  {\bf u}_\alpha)\cdot{\bf i}^z  = v_{\alpha,x} - u_{\alpha,y}   \label{eq12} \\
\omega_2  & = &  (\nabla \times {\bf u}_2) \cdot {\bf i}^z = z_{\alpha,x} (A_y + z_\alpha B_y) - z_{\alpha,y} (A_x + z_\alpha B_x)  
 \label{eq13} 
\ea
Note that there is a typo in (\ref{eq13}) in Shi et al. (2012) ($\overline {\bf u}_2$ should be  ${\bf u}_2$). Following Nwogu (1993), $z_\alpha$ is usually chosen in order to optimize the apparent dispersion relation of the linearized model relative to the full linear dispersion in some sense.  In particular, the choice $\alpha = (z_\alpha / h)^2 /2 + z_\alpha / h = -2/5$ recovers a Pad\'{e} approximant form of the dispersion relation, while the choice $\alpha = -0.39$, corresponding to the choice $z_\alpha = -0.53 h$, minimizes the maximum error in wave phase speed occurring over the range $0 \leq kh \leq \pi$.  Kennedy et al (2001) showed that, allowing $z_\alpha$ to move up and down with the passage of the wave field,  allowed a greater degree of flexibility in optimizing nonlinear behavior of the resulting model equations.  In the examples chosen here, where a great deal of our focus is on the behavior of the model from the break point landward, we adopt Kennedy et al's ``datum invariant'' form
\be
z_\alpha = -h + \beta H = (\beta - 1) h + \beta \eta = \zeta h + (1+\zeta)\eta \label{eq14}
\ee
with $\zeta = -0.53$ as in Nwogu (1993) and $\beta = 1 + \zeta = 0.47$  This corresponds in essence to a $\sigma$ coordinate approach, which places the reference elevation at a level 53\% of the total local depth below the local water surface.  This also serves to keep the model reference elevation within the actual water column over the entire wetted extent of the model domain.

\subsection{Treatment of the surface gradient term}

The hybrid numerical  scheme  requires a conservative form of continuity equation and momentum equations,   thus requiring a modification of the leading order pressure term in the momentum equation.  A numerical imbalance problem occurs  when the surface gradient term is conventionally split into an artificial flux gradient and a source term that includes the effect of the bed slope for a non-uniform bed.   To eliminate errors introduced by the  traditional depth gradient method (DGM), a so-called surface gradient method (SGM) proposed by Zhou et al. (2001) was adopted in the TVD based-Boussinesq models in the recent literatures. Zhou et al. discussed an example of SGM in 1-D and verified that the slope-source term may be canceled out by part of the numerical flux term associated with water depth, if the bottom elevation at the cell center is constructed using the average of bottom elevations at two cell interfaces. Zhou et al. also showed a 2D application, but without explicitly describing 2D numerical schemes. Although this scheme can be extended into 2D following the same procedure as in 1D, it was found that the 2D extension may not be trivial in terms of the bottom construction for a 2D arbitrary bathymetry. Kim et al. (2008) pointed out that the water depth in the slope-source term should be written in a discretized form rather than the value obtained using the bottom construction, implying that their revised SGM is valid for general 2D applications.

For the higher-order schemes, such as the fourth-order MUSCL-TVD scheme (Yamamoto and Daiguji, 1993, Yamamoto et al., 1998) used in the recent Boussinesq applications, the original SGM and the revised SGM may not be effective in removing the artificial source. This problem was recently noticed by some authors, such as Roeber et al. (2010),  who kept a first-order scheme (second-order for normal conditions) for the numerical flux term and the slope-source term in order to ensure a well-balanced solution,  without adding noise for a rapidly varying bathymetry.

In fact, the imbalance problem can be solved by a reformulation of this term in terms of deviations  from an unforced but separately specified equilibrium state (see general derivations in Rogers et al., 2003 and recent application in Liang and Marche, 2009). Using this technique, the surface gradient term may be split as  
\be
g H \nabla \eta = \nabla \left[ \frac{1}{2} g (\eta^2 + 2 h \eta )\right] - g \eta \nabla h  \label{eq15}
\ee
which is well-balanced for any numerical order  under an unforced stationary condition (still water condition).

\subsection{Conservative form of  fully nonlinear Boussinesq equations in Cartesian coordinates}

For Chen's (2006) equations or the minor extension considered here, $H \ua$ can be used as a conserved variable in the  construction of a conservative form of Boussinesq equations, but this results in a source term in the mass conservation equation,  such as in Shiach and Mingham (2009) and Roeber et al. (2010). An alternative  approach is to use ${\bf M}$ as a conserved variable in terms of the physical meaning of mass conservation. In this study, we used ${\bf M}$, instead of $H \ua$, in the following derivations of the conservative form of the fully nonlinear Boussinesq equations.  

Using $\bf{M}$ from (\ref{eq6}) together with the vector identity
\be
\nabla \cdot ({\bf u} {\bf v}) = \nabla {\bf u} \cdot {\bf v} + (\nabla \cdot {\bf v}) {\bf u}  \label{eq16}
\ee
allows (\ref{eq8}) to be rearranged as 
\ba
&   & {\bf M}_t  + \nabla \cdot \left(\frac{{\bf M} {\bf M} }{H}\right)  + gH\nabla\eta  \nonumber \\
&   & = H \left\{ {\utwo}_{,t} + \ua \cdot \nabla \utwo + \utwo \cdot \nabla \ua - {\bf V}_1 - {\bf V}_2 - {\bf V}_3 -{\bf R} \right\}  \label{eq17}
\ea

Following Wei et al. (1995), we separate the time derivative dispersion terms  in  ${\bf V}_1$ according to
\be
{\bf V}_1 = {\bf V}_{1,t}^\prime +{\bf V}_1^{\prime \prime}   \label{eq18}
\ee
where 
\be
{\bf V}_1^\prime  =  \frac{z_\alpha^2}{2} \nabla B + z_{\alpha} \nabla A  - \nabla \left[ \frac{\eta^2}{2} B + \eta A \right]   
\label{eq19}
\ee
and
\be
{\bf V}_1^{\prime \prime} = \nabla \left[ \eta_t  (A + \eta B) \right]  \label{eq20}
\ee

Using (\ref{eq15}),  (\ref{eq19}) and (\ref{eq20}), the momentum equation can be rewritten as
\ba
&   & {\bf M}_t + \nabla \cdot \left [\frac{ {\bf M} {\bf M} }{H}\right] + \nabla \left [ \frac{1}{2} g (\eta^2 +2 h \eta) \right ]  =  \\ \nonumber
&   & = H \left\{ 
{\utwo}_{,t}  + \ua \cdot \nabla \utwo + \utwo \cdot \nabla \ua - {\bf V}^\prime_{1,t} - {\bf V}_1^{\prime\prime}  - {\bf V}_2 - {\bf V}_3 - {\bf R} \right\} + g \eta \nabla h   \label{eq21}
\ea

A difficulty usually arises in applying the adaptive time-stepping scheme to the time derivative dispersive terms  $\bar{u}_{2,t}$ and ${\bf V}_{1,t}^\prime$, which was usually calculated using values stored in several time levels in the previous Boussinesq codes such as in Wei et al. (1995) and Shi et al. (2001).   To prevent this, the equation can be re-arranged by merging the time derivatives on the right hand side into the time derivative term on the left hand side, giving  
\ba
     {\bf V}_t &&+ \nabla \cdot \left [\frac{ {\bf M} {\bf M}}{H} \right] + \nabla \left [ \frac{1}{2} g (\eta^2 +2 h \eta) \right ]  =  
   \eta_t ({\bf V}_1^{\prime} -  \utwo ) \\
 \nonumber   &&+ H \left (  \ua \cdot \utwo + \utwo \cdot \nabla \ua  - {\bf V}_1^{\prime \prime} - {\bf V}_2 -{\bf V}_3  - {\bf R} \right )    + g \eta \nabla h 
\label{eq22}
\ea
where
\be
{\bf V} = H (  \ua + {\bf V}_1^\prime) \label{eq23}
\ee
In (\ref{eq22}) $\eta_t$ can be calculated explicitly using (\ref{eq5}) as  in Roeber et al. (2010). Equations  (\ref{eq5}) and (\ref{eq21}) are  the governing equations solved in this study.  As ${\bf V}$ is obtained, the velocity $\ua$ can be found by solving a system of equation with tridiagonal matrix  formed by (\ref{eq22}),  in which all cross-derivatives are moved to the right-hand side of the equation.  

\subsection{Weakly nonlinear Boussinesq equations in spherical coordinates}

The weakly nonlinear Boussinesq equations in spherical coordinates are solved in the same model framework. We used the spherical 
Boussinesq equations  derived by  Kirby et al.  (2004, 2012):


\ba
& &H_t + \frac{1}{r_0 \cos\theta}\left\{ (Hu)_{\phi} + (H v \cos\theta)_{\theta}\right\} = 0
\label{eq3.1} \\
& &u_t - f v + \frac{1}{r_0 \cos\theta}u u_{\phi} + \frac{1}{r_0}vu_{\theta} \ 
+ \frac{g}{r_0 \cos\theta}\eta_{\phi} \nonumber \\ 
& &+ \frac{1}{r_0^2 \cos^2\theta}\left\{ \frac{h^2}{6} \left[ u_{\phi\phi t} +
(v\cos\theta)_{\phi\theta t} \right] - \frac{h}{2} \left[ (hu_t)_{\phi\phi} +
(h\cos\theta v_t)_{\phi\theta}\right] \right\} \nonumber \\  
& & - \tau_b^{\phi} + \frac{1}{r_0 \cos\theta} (BFT)_{\phi} = 0  \label{eq3.2} \\
& &v_t + fu + \frac{1}{r_0 \cos\theta}u v_{\phi} + \frac{1}{r_0} vv_{\theta}  
+ \frac{g}{r_0} \eta_{\theta} \nonumber \\ 
& &+ \frac{1}{r_0^2}\left\{\frac{h^2}{6} \left[\frac{1}{\cos\theta}\{ u_{\phi t} +
(v\cos\theta)_{\theta t} \} \right] _{\theta} - \frac{h}{2} \left[ \frac{1}{\cos\theta} \{
(hu_t)_{\phi} + (h\cos\theta v_t)_{\theta} \} \right]_{\theta} \right\}  \nonumber \\  
& & - \tau_b^{\theta} + \frac{1}{r_0} (BFT)_{\theta} = 0  \label{eq3.3}
\ea
where $\theta$ and $\phi$ denote latitude and longitude, respectively, $r_0$ is the earth radius, $f$ is the Coriolis parameter, $H = h + \eta$, ($u,v$) represent the depth-averaged velocity. $BFT$ denotes forcing terms resulting from motion of the ocean bottom and it is not taken into account in the present program. 

To facilitate solving the spherical equations  in the same model framework as in the Cartesian coordinates, we solve the spherical governing equations by transforming the equations into an equivalent set of equations in Cartesian coordinates using a standard cylindrical projection. We define

\ba
\left \{
\begin{array}{ll}
\xi_1= &r_0 \cos \theta_0 (\phi - \phi_0) \\
\xi_2 =& r_0 (\theta - \theta_0)
\end{array}
\right.
\ea
where $(\phi_0, \theta_0)$ are the reference longitude and latitude, respectively.  The differentials of $\xi_1$ and $\xi_2$ are
\ba
\left \{
\begin{array}{ll}
d \xi_1= &r_0 \cos \theta_0 d \phi \\
d \xi_2 =& r_0 d \theta
\end{array}
\right.
\ea



$d\phi$ and $d\theta$ in (\ref{eq3.1}) - (\ref{eq3.3}) are replaced by $d\xi_1$ and $d\xi_2$. Detailed derivations for each term are described below.

\ba
&& \frac{1}{r_0 \cos \theta} (Hu)\phi = S_p (Hu)_{\xi_1}
\\
&&
\frac{1}{r_0 \cos \theta} (Hv\cos \theta)_\theta = \frac{1}{r_0 \cos \theta}  \left [ \cos \theta (Hv)_\theta - Hv \sin \theta \right ]
= (Hv)_{\xi_2} - \frac{1}{r_0} \tan \theta Hv
\\
&&
\frac{1}{r_0 \cos \theta} u u_\phi =S_p  u u_{\xi_1}
\\
&&
\frac{1}{r_0} v u_\theta = v u_{\xi_2}
\\
&&
\frac{1}{r_0 \cos \theta} g  \eta_\phi = S_p  g \eta_{\xi_1}
\\
&&
\frac{h^2}{6} \frac{1}{r_0^2 \cos ^2 \theta} u_{\phi \phi t} = S_p^2 \frac{h^2}{6} u_{\xi_1 \xi_1 t}
\\
&&
\frac{h^2}{6} \frac{1}{r_0^2 \cos ^2 \theta} (v \cos \theta)_{\phi \theta t} = \frac{h^2 S_p}{6} \left ( v_{\xi_1 \xi_2} -  \frac{1}{r_0} \tan \theta v_{\xi_1}  \right)_t
\\
&&
- \frac{h}{2} \frac{1}{r_0^2 \cos^2 \theta} (h u)_{\phi \phi t} = - \frac{hS_p^2}{2} (hu)_{\xi_1 \xi_1 t}
\\
&&
- \frac{h}{2} \frac{1}{r_0^2 \cos ^2 \theta} (hv \cos \theta)_{\phi \theta t} = - \frac{h S_p}{2} \left [ (hv)_{\xi_1 \xi_2} - \frac{1}{r_0} \tan \theta (hv)_{\xi_1} \right]_t
\\
&&
\frac{1}{r_0 \cos \theta} u v_\phi = S_p u v_{\xi_1}
\\
&&
\frac{1}{r_0} v v_\theta = v v_{\xi_2}
\\
&&
\frac{1}{r_0} g \eta_\theta = g \eta_{\xi_2}
\\
&&
\frac{h^2}{6} \frac{1}{r_0^2} \left ( \frac{u_{\phi t}}{\cos \theta} \right)_\theta = \frac{h^2 S_p}{6} \left( u_{\xi_1 \xi_2} + \frac{1}{r_0} \tan \theta u_{\xi_1} \right)_t 
\\
&&
- \frac{h}{2} \frac{1}{r_0^2} \left[ \frac{(hu)_{\phi t}}{\cos \theta} \right]_\theta = - \frac{h S_p}{2} \left[ (hu)_{\xi_1 \xi_2} + \frac{1}{r_0} \tan \theta (hu)_{\xi_1} \right]_t
\\
&&
\frac{h^2}{6} \frac{1}{r_0^2} \left [  \frac{(v\cos \theta)_{\theta t}}{\cos \theta}\right ]_\theta 
= \frac{h^2}{6} \left[   v_{\xi_2 \xi_2} - \frac{1}{r_0} \tan \theta v_{\xi_2}  - \frac{1}{r_0^2 \cos^2 \theta} v \right]_t
\\
&&
- \frac{h}{2} \frac{1}{r_0^2} \left[ \frac{(hv \cos \theta)_{\theta t}}{\cos \theta} \right]_\theta 
= -\frac{h}{2} \left[   (hv)_{\xi_2 \xi_2} - \frac{1}{r_0} \tan \theta (hv)_{\xi_2}  - \frac{1}{r_0^2 \cos^2 \theta} h v \right]_t
\ea
where $S_p$ is a spherical coordinate correction factor expressed by
\be
S_p = \frac{\cos \theta_0}{\cos \theta}.
\ee

The equations in ($\xi_1,\xi_2$) coordinates are

\be
H_t + S_p (Hu)_{\xi_1} + (Hv)_{\xi_2} = \frac{1}{r_0} \tan \theta Hv
\ee

\be
u_t + S_p uu_{\xi_1} +vu_{\xi_2} -fv + S_p g\eta_{\xi_1} +F_t - \tau_b^{\xi_1} +  S_p (BFT)_{\xi_1} = 0
\ee

\be
v_t + S_p uv_{\xi_1} +vv_{\xi_2} +fu +g \eta_{\xi_2} +G_t -\tau_b^{\xi_2} +(BFT)_{\xi_2}
\ee
where
\be
F = \frac{h^2 S_p^2}{6} u_{\xi_1 \xi_1} + \frac{h^2 S_p}{6} (v_{\xi_1 \xi_2}- \frac{1}{r_0}\tan \theta v_{\xi_1}) 
-\frac{hS_p^2}{2} (hu)_{\xi_1 \xi_1} -\frac{hS_p}{2} \left[ (hv)_{\xi_1 \xi_2} - \frac{1}{r_0} \tan \theta (hv)_{\xi_1} \right]
\ee 

\ba
\nonumber
&&
G = \frac{h^2S_p}{6} \left(u_{\xi_1 \xi_2} +\frac{1}{r_0} \tan \theta u_{\xi_1} \right) +\frac{h^2}{6} \left( v_{\xi_2 \xi_2} 
 - \frac{1}{r_0} \tan \theta v_{\xi_2} - \frac{1}{r_0^2\cos^2 \theta} v
\right) \\
&&
-\frac{h S_p}{2} \left[ (hu)_{\xi_1 \xi_2} +\frac{1}{r_0} \tan \theta (hu)_{\xi_1}  \right] 
- \frac{h}{2} \left[ (hv)_{\xi_2 \xi_2}  
- \frac{1}{r_0} \tan \theta (hv)_{\xi_2} - \frac{1}{r_0^2 \cos^2\theta} (hv)
 \right]
\ea

  The conservation forms of the spherical equations can be rewritten in the same form of  the Cartesian equations (\ref{tvd}) and ${\bf\Psi}$ ,${\bf \Theta}$ and ${\bf S}$ are defined as


\ba
{\bf \Psi} = \left( \begin{array}{c} \eta \\
U_s \\
V_s \end{array} \right) ,
\ \ \ \  \ \  {\bf \Theta} = \left( \begin{array}{c}
S_p P {\bf i} + Q {\bf j} \\
\left[\frac{S_p P^2}{h+\eta} +\frac{1}{2}S_p g (\eta^2 + 2 \eta h) \right ] {\bf i} + \frac{P Q}{h+\eta} {\bf j} \\
\frac{S_p P Q}{h+\eta} {\bf i} + \left[\frac{Q^2}{h+\eta} +\frac{1}{2} g (\eta^2 + 2\eta h) \right] {\bf j} 
\end{array}
\right) .
\ea
\ba
{\bf S} = \left( \begin{array}{c} 
\frac{1}{r_0} \tan \theta (h+\eta) v\\
S_p g \eta \frac{\partial h}{\partial \xi_1}   +  f(h+\eta)v+ \tau_b^{\xi_1} + \psi_1  \\
g \eta \frac{\partial h}{\partial \xi_2}  - f(h+\eta)u + \tau_b^{\xi_2}  +\psi_2
\end{array}
\right) ,
\ea
where $P = (h+\eta)u$, $Q=(h+\eta)v$,
\be
U_s = (h+\eta)(u + F)
\ee
\be
V_s  = (h+\eta)(v + G)
\ee

\be
\psi_1=\eta_t F
\ee

\be
\psi_2  = \eta_t G
\ee


\section{Numerical schemes}

\subsection{Compact form of governing equations}

We define
\ba
\nonumber
&& {\bf u}_\alpha = (u, v) ,\\
\nonumber 
&& \utwo = (U_4, V_4), \\
\nonumber
&& {\bf M} = (P, Q)  = H  \left[ u + U_4, v + V_4 \right],\\
\nonumber
&& {\bf V}_1^{\prime} = (U_1^{\prime}, V_1^{\prime}) , \\
\nonumber
&& {\bf V}_1^{\prime \prime} = (U_1^{\prime \prime}, V_1^{\prime \prime})  ,\\
\nonumber
&&  {\bf V}_2 = (U_2, V_2) , \\
\nonumber
&& {\bf V} = (U,V) = H \left[  (u +  U_1^{\prime}),  (v +  V_1^{\prime}) \right] .
\ea
The generalized conservative form of Boussinesq equations can be written as
\be
\frac{\partial {\bf \Psi}}{\partial t} + \nabla \cdot {\bf \Theta}({\bf \Psi}) = {\bf S}
\label{tvd}
\ee
where ${\bf \Psi}$ and ${\bf \Theta} ({\bf \Psi})$ are  the vector of conserved variables and  the flux vector function, respectively, and are given by
\ba
{\bf \Psi} = \left( \begin{array}{c} \eta \\
U \\
V \end{array} \right) ,
\ \ \ \  \ \  {\bf \Theta} = \left( \begin{array}{c}
P {\bf i} + Q {\bf j} \\
\left[\frac{P^2}{H} +\frac{1}{2}g (\eta^2 + 2 \eta h) \right ] {\bf i} + \frac{P Q}{H} {\bf j} \\
\frac{P Q}{H} {\bf i} + \left[\frac{Q^2}{H} +\frac{1}{2} g (\eta^2 + 2\eta h) \right] {\bf j} 
\end{array}
\right) .
\ea
 % Note that the definition of  $(P, Q)$ is different from that in Roeber et al. (2010) who used  $(hu_\alpha, hv_\alpha)$ as momentum fluxes.  The source terms $S_b$ and $S_f$ are
\ba
{\bf S} = \left( \begin{array}{c} 
0\\
g \eta \frac{\partial h}{\partial x}  +\psi_x + H R_x  \\
g \eta \frac{\partial h}{\partial y} + \psi_y + H R_y
\end{array}
\right) ,
\ea
where 
\be 
\psi_x =  \eta_t (U_1^{\prime}-U_4) + H \left( u U_{4,x} + v U_{4,y} + U_4 u_x +V_4 u_y  - U_1^{\prime \prime}-  U_2 -  U_3 \right) 
\ee

\be 
\psi_y =  \eta_t (V_1^{\prime}-V_4) + H \left( u V_{4,x} + v V_{4,y} + U_4 v_x +V_4 v_y - V_1^{\prime \prime} -  V_2 -  V_3 \right) 
\ee

The expanded forms of $(U_1^{\prime}, V_1^{\prime}), (U_1^{\prime \prime}, V_1^{\prime \prime}), (U_2, V_2), (U_3, V_3) $ and $ (U_4, V_4)$ can be found in Appendix A. For the term ${\bf R}$, the bottom stress is approximated using a quadratic friction equation. A Smagorinsky (1963)-like subgrid turbulent mixing algorithm is implemented following Chen et al. (1999). 
%\be
%\tau_b^x = C_f u \sqrt{u^2 +v^2}, \ \ \ \  \tau_b^y = C_f v \sqrt{u^2 +v^2}
%\ee
%where $C_f$ is the friction coefficient.

\subsection{Spatial discretization}

A combined finite-volume and finite-difference method is applied to the spatial discretization.
For the flux terms and the first-order derivative terms,
both high-order and low-order MUSCL-TVD schemes are implemented.
In previous version of FUNWAVE-TVD model (lower than Version 3.0), the fourth-order MUSCL-TVD scheme by Yamamoto et al. (1998) was used. However, in some cases, numerical instability occurred in long time simulations.

In present version, the fourth-order MUSCL-TVD scheme by Erduran et al. (2005) who modified Yamamoto et al.'s (1998)  fourth-order approach is applied for high-order scheme.
In $x$-direction, for example, the interface construction by the fourth-order MUSCL-TVD scheme can be written as follows:
\be
\phi^L_{i+1/2} = \phi_i +\frac{1}{6} \left[ \chi(r) \Delta^* \phi_{i-1/2} + 2 \, \chi(1/r) \Delta^* \phi_{i+1/2} \right ]
\label{left}
\ee
\be
\phi^R_{i-1/2} = \phi_i -\frac{1}{6} \left[ 2 \, \chi(r) \Delta^* \phi_{i-1/2} + \chi(1/r) \Delta^* \phi_{i+1/2} \right ]
\label{right}
\ee
where $\phi^L_{i+1/2} $ is the constructed value at the left-hand side of the interface $i+\frac{1}{2}$ and  $\phi^R_{i-1/2} $ is the value at the right-hand side of the interface $i - \frac{1}{2}$.  The values of $\Delta^* \phi$ are evaluated as follows:
\ba
\nonumber
&&\Delta^* \phi_{i+1/2} = \Delta \phi_{i+1/2} - \Delta^3 \bar{\phi}_{i+1/2} /6, \\
\nonumber && \Delta \phi_{i+1/2} = \phi_{i+1} - \phi_{i} ,\\
\nonumber  && \Delta^3 \bar{\phi}_{i+1/2} = \Delta \bar{\phi}_{i+3/2} - 2 \Delta \bar{\phi}_{i+1/2} + \Delta \bar{\phi}_{i-1/2}, \\
\nonumber && \Delta \bar{\phi}_{i-1/2} =\mbox{minmod} (\Delta \phi_{i-1/2}, \Delta \phi_{i+1/2}, \Delta \phi_{i+3/2}) , \\
\nonumber &&  \Delta \bar{\phi}_{i+1/2} =\mbox{minmod} (\Delta \phi_{i+1/2}, \Delta \phi_{i+3/2}, \Delta \phi_{i-1/2}) , \\
\nonumber && \Delta \bar{\phi}_{i+3/2} =\mbox{minmod} (\Delta \phi_{i+3/2}, \Delta \phi_{i-1/2}, \Delta \phi_{i+1/2}) \\
\label{minmod}
\ea
In (\ref{minmod}), minmod represents the Minmod limiter and is given by
\be
\mbox{minmod} (j,k,l) = \mbox{sign} (j) \mbox{max} \{ 0, \mbox{min} [|j|, 2 \mbox{sign} (j) k, 2 \mbox{sign} (j) l ] \} .
\ee

$\chi(r)$ in (\ref{left}) and (\ref{right}) is the limiter function. The original scheme introduced by Yamamoto et al. (1998) uses the Minmod limiter as used in (\ref{minmod}).
Erduran et al. (2005) found that the use of the van-Leer limiter for the third-order part gives more accurate results.
The van-Leer limiter can be expressed as
\be
\chi(r) = \frac{r+|r|}{1+r},
\ee
where
\be
r = \frac{\Delta^* \phi_{i+1/2}}{\Delta ^* \phi_{i-1/2}}.
\ee

For the low-order scheme, the second-order MUSCL-TVD scheme with van-Leer limiter is applied.
The reconstruction at cell interface can be written as (Zhou et al., 2001)
%%%%%%%%%%%%%%%%%%%%%
\begin{equation}
  \phi = \phi_i + (x-x_i) \sigma \phi_i.
\end{equation}
%%%%%%%%%%%%%%%%%%%%%
or,
\begin{eqnarray}
  \phi_{i+1/2}^{L} = \phi_{i} + \frac{1}{2} \Delta x \, \sigma \phi_{i}, \quad
  \phi_{i-1/2}^{R} = \phi_{i} - \frac{1}{2} \Delta x \, \sigma \phi_{i},
\end{eqnarray}
%%%%%%%%%%%%%%%%%%%%%
where
\begin{equation}
  \sigma \phi_i
  = \Upsilon \bigg(
  \frac{\phi_{i+1}-\phi_{i}}{x_{i+1}-x_{i}},
  \frac{\phi_{i}-\phi_{i-1}}{x_{i}-x_{i-1}}
  \bigg).
\end{equation}
%%%%%%%%%%%%%%%%%%%%%
The van Leer limiter in the second-order MUSCL-TVD scheme can be written as
\begin{equation}
\Upsilon(a,b) = \frac{a|b| + |a|b}{|a|+|b|}.
\end{equation}

If a numerical solution from the fourth-order scheme can not be converged, for example, in a case of modeling extremely large wave height, the second-order MUSCL-TVD scheme is recommended.
However, a grid resolution higher than that used for the fourth-order scheme may be required to ensure model accuracy. 


The numerical fluxes are computed using a HLL approximate Riemann solver
\be
{\bf \Theta} ({\bf \Psi}^L, {\bf \Psi}^R)= \left \{ \begin{array}{ll} {\bf \Theta} ({\bf \Psi}^L) & \mbox{if} \ \ \ s_L \ge 0 \\
{\bf \Theta}^* ({\bf \Psi}^L, {\bf \Psi}^R) & \mbox{if} \ \ \ s_L < 0 < s_R \\
{\bf \Theta}({\bf \Psi}^R) & \mbox{if} \ \ \ s_R \le 0,
\end{array}  \right.
\ee
where
\be
{\bf \Theta^*} ({\bf \Psi}^L, {\bf \Psi}^R) = \frac{s_R {\bf \Theta} ({\bf \Psi}^L) -s_L {\bf \Theta}({\bf \Psi}^R) + s_L s_R ({\bf \Psi}^R - {\bf \Psi}^L)}{s_R - s_L}
\ee
The wave speeds of the Riemann solver are given by
\be
s_L= \mbox{min} ({\bf V}^L \cdot {\bf n} - \sqrt{g (h+\eta)^L} , u_s -\sqrt{\varphi_s}),  
\label{sl}
\ee
\be
s_R= \mbox{max} ({\bf V}^R \cdot {\bf n} + \sqrt{g (h+\eta)^R},  u_s +\sqrt{\varphi_s}),  
\label{sr}
\ee
in which $u_s$ and $\varphi_s$ are estimated as
\be
u_s =\frac{1}{2} ({\bf V}^L + {\bf V}^R)\cdot {\bf n} + \sqrt{g (\eta + h)^L} - \sqrt{g(\eta+h)^R}
\ee
\be
\sqrt{\varphi_s} = \frac{\sqrt{g (\eta + h)^L}+\sqrt{g (\eta + h)^R}}{2} +\frac{({\bf V}^L - {\bf V}^R)\cdot {\bf n}}{4}
\ee
and ${\bf n}$ is the normalized side vector for a cell face.

Higher derivative terms in $\psi_x$ and $\psi_y$ were discretized using a central difference scheme at the cell centroids,  as in Wei et al. (1995). No discretization of dispersion terms at the cell interfaces is needed due to using ${\bf M}$ as a flux variable.   The Surface Gradient Method (Zhou et al, 2001) was used to eliminate unphysical oscillations. 
Because the pressure gradient term is re-organized as in section 2.2, there is no imbalance issue for the high-order MUSCL scheme. 


\subsection{Time stepping}

The third-order Strong Stability-Preserving (SSP) Runge-Kutta scheme for nonlinear spatial discretization (Gottlieb et al., 2001) was adopted for time stepping. The scheme is given by
\ba
\nonumber
&& {\bf \Psi}^{(1)} = {\bf \Psi}^{n}  + \Delta t (- \nabla \cdot {\bf \Theta} ({\bf \Psi}^n) + {\bf S}^{(1)} ) \\
&&  {\bf \Psi}^{(2)} = \frac{3}{4}{\bf \Psi}^{n}  + \frac{1}{4} \left[   {\bf \Psi}^{(1)} +  \Delta t \left (- \nabla \cdot {\bf \Theta} ({\bf \Psi}^{(1)} ) + {\bf S}^{(2)} \right) \right] \\
\nonumber
&&  {\bf \Psi}^{n+1} = \frac{1}{3}{\bf \Psi}^{n}  + \frac{2}{3} \left[   {\bf \Psi}^{(2)} +  \Delta t \left (- \nabla \cdot {\bf \Theta} ({\bf \Psi}^{(2)} ) + {\bf S}^{n+1} \right) \right]
\label{runge}
\ea
in which ${\bf \Psi}^{n}$ denotes ${\bf \Psi}$  at time level $n$.  ${\bf \Psi}^{(1)}$ and ${\bf \Psi}^{(2)}$ are values at intermediate stages in the Runge-Kutta integration. As ${\bf \Psi}$ is obtained at each intermediate step,  the velocity $(u, v)$ can be solved by a system of tridiagonal matrix equations formed by (\ref{eq22}).    ${\bf S}$  needs to be updated using ($u,v,\eta$) at the corresponding time step and an iteration is needed to achieve convergence.  %The detailed tridiagonal matrix equation can be found in Appendix B.  

An  adaptive time step is chosen, following the Courant-Friedrichs-Lewy (CFL) criterion:
\be
\Delta t = C  \mbox{min} \left ( \mbox{min} \frac{\Delta x}{|u_{i,j}| + \sqrt{g (h_{i,j} +\eta_{i,j})}},  \mbox{min} \frac{\Delta y}{|v_{i,j}| + \sqrt{g (h_{i,j} +\eta_{i,j})}} \right )
\label{cfl}
\ee
where $C$ is the Courant number and $C=0.5$ was used in the following examples.  

\subsection{Wave breaking}  

There are two breaking algorithms implemented in the model. One takes the advantage of the shock-capturing scheme in TVD. 
It  follows the approach of Tonelli and Petti (2009),  who successfully used the ability of  NSWE  with a TVD scheme to model moving hydraulic jumps. Thus, the fully nonlinear Boussinesq equations are switched  to NSWE at cells where the Froude number exceeds  a certain threshold. Following Tonelli and Petti, the ratio of wave height to total water depth is chosen as  the criterion to switch from Boussinesq to NSWE, with  threshold value  set to 0.8,  as suggested by Tonelli and Petti. 

The other one is the original eddy-viscosity scheme used in the previous version of FUNWAVE (Kennedy et al., 2000). To fit the eddy-viscosity method in the TVD scheme, the artificial eddy viscosity terms are modified as below

\be
{\bf R}_{bx} = \frac{\partial }{\partial x} (\nu \frac{\partial P}{\partial x}) + \frac{\partial }{\partial y} (\nu \frac{\partial P}{\partial y} )
\label{rx}
\ee
\be
{\bf R}_{by} = \frac{\partial }{\partial y} (\nu \frac{\partial Q}{\partial y}) + \frac{\partial }{\partial x} (\nu \frac{\partial Q}{\partial x}) 
\label{ry}
\ee
%\be
%{\bf R}_{bx} = \frac{\partial }{\partial x} (\nu \frac{\partial P}{\partial x}) + \frac{1}{2} \frac{\partial }{\partial y} (\nu \frac{\partial P}{\partial y} +\nu \frac{\partial Q}{\partial x}) 
%\label{rx}
%\ee
%\be
%{\bf R}_{by} = \frac{\partial }{\partial y} (\nu \frac{\partial Q}{\partial y}) + \frac{1}{2} \frac{\partial }{\partial x} (\nu \frac{\partial Q}{\partial x} +\nu \frac{\partial P}{\partial y}) 
%\label{ry}
%\ee
Note that the form of (\ref{rx}) and (\ref{ry}) is slightly different from that in Kennedy et al. (2000). The present form was found to give a more stable numerical solution as the cross-derivatives removed. In (\ref{rx}) and (\ref{ry}), $\nu$ is the artificial eddy viscosity defined by
\be
\nu = B \delta_b^2 (h+\eta) \eta_t
\label{nu}
\ee
where $\delta_b = 1.2$. In Kennedy et al. (2000), $B$ varies smoothly from 0 to 1 so as to avoid an impulsive start of breaking and the resulting instability. In the present TVD model, because there is no instability problem found, we adopt a constant value $B=1$ as breaking is initiated
\be
B =  \left \{  \begin{array}{l} 1 \ \ \ \  \eta_t \ge  \eta_t^*  \\
0 \ \ \ \ \eta_t <  \eta_t^*
\end{array}
\right .
\ee
The parameter $\eta_t^*$ determines the onset and cessation of breaking. Following Kennedy et al., a breaking event begins when $\eta_t$ exceeds some initial threshold value $\eta_t^{(I)}$, as breaking develops, the wave will continue to break until $\eta_t$ drops below $\eta_t^{(F)}$. However, we do not use the smooth transition as in Kennedy et al. because the present TVD scheme did not encounter any instability problem.  The default values of $\eta_t^{(I)}$ and $\eta_t^{(F)}$ are $0.65\times 2  \sqrt{gh}$ and  $0.15 \sqrt{gh}$ as in the previous FUNWAVE version (i.e., Cbrk1 = 0.65 and Cbrk2=0.15 in the present version, see the example in the next section). However, the recent tests showed $\eta_t^{(I)}$ should be slightly larger to match the laboratory data. 

It should be mentioned that, instead of using $U$ and $V$ in the diffusion terms, we used $P$ and $Q$ as shown in (\ref{rx}) and (\ref{ry}).   The formulations  (\ref{rx}) and (\ref{ry}) combined with the TVD scheme make the model more stable than  using $U$ and $V$. 

\subsection{Wetting-drying schemes for shallow water}

The wetting-drying scheme for modeling  a moving boundary is straightforward. The normal flux ${\bf n} \cdot {\bf M}$ at the cell interface of a dry cell is set to zero. A mirror boundary condition is applied to the fourth-order MUSCL-TVD scheme and discretization of  dispersive terms in ${\psi_x, \psi_y}$ at dry cells. It may be noted that the wave speeds of the Riemann solver  (\ref{sl}) and (\ref{sr}) for a dry cell are modified as 
\be
s_L= {\bf V}^L \cdot {\bf n} - \sqrt{g (h+\eta)^L} ,  \ \ \ \    s_R= {\bf V}^L \cdot {\bf n} +2  \sqrt{g (h+\eta)^L}  \  \  \  \mbox{(right dry cell)}
\ee
and
\be
s_L= {\bf V}^R \cdot {\bf n} - \sqrt{g (h+\eta)^R} ,  \ \ \ \    s_R= {\bf V}^R \cdot {\bf n} +2  \sqrt{g (h+\eta)^R}  \  \  \  \mbox{(left dry cell)}
\ee


\subsection{Boundary conditions}

We implemented various boundary conditions including wall boundary condition, absorbing boundary condition following Kirby et al. (1998) and periodic boundary condition following Chen et al. (2003).

\subsubsection{Sponge layer}

The sponge layer technique introduced by Larsen and Dancy (L-D type, 1983) is implemented in the code. In this method, the variables $\phi$( i.e., $\eta, u, v$) are directly attenuated at every time step:

\be
\phi = \phi /C_s
\ee
where $C_s$ is a damping coefficient function defined by
\be
C_s = \alpha_s^{\gamma_x^{i-1}}, \ \ \ \ \ i=1,2, ..., n
\ee
where $\alpha_s$ and $\gamma_s$ are two free parameters. $i$ represents grid numbers. Chen et al. (1999) suggested that $\alpha_s =2$, $\gamma_s = 0.88 - 0.92$, and $n=50 - 100$. The length of the sponge layer is usually taken to be one or two times the typical wavelength. Chen et al also pointed out that the damping coefficients for optimal absorption are somewhat case-sensitive. 

Recently, some problem was found in application of L-D type sponge layer for long-term simulations. 
 The direct damping method combined with the TVD scheme  generates sawtooth noises with a $2 dx$ wave length. The sawtooth noises are usually not noticeable due to small magnitudes. However, they grow gradually with time and may become significant in a long term simulation. If this problem occurs, we suggest using the following friction-type or viscous type sponge layers. Using the combination of L-D and friction/viscous sponge layers may remove the sawtooth noises and also make the wave damping more efficient. 
 
The friction-type and viscous type sponge layers directly use the friction terms and diffusion terms existing in the model. The source term for the friction-type sponge can be described as
\be
  F_{frc} = - C_{sponge} |{\bf u_\alpha}|  (u_\alpha, v_\alpha) h
  \label{fric}
\ee
Note that depth $h$ is added in (\ref{fric}) to make the source term depth-independent in terms of the flux-type momentum equations. For the diffusion-type sponge, the description of diffusion term follows exactly the eddy-viscosity breaking formulation with spatial varying viscosity coefficients $\nu_{sponge}$. 
 Both coefficients are smoothly ramped in space at the sponge layer boundaries. For example, 
for a sponge layer on the left end of the domain,  $C_{sponge}$ can be written as
\be
C_{sponge} = C_{max} \left (1-  \mbox{tanh} \frac{10 (i-1)}{I_{\mbox{width}}-1} \right)
\ee
where $C_{max}$ is the maximum value of $C_{sponge}$ used in the sponger layer. $i$ and $I_{\mbox{width}}$ represent point number and the layer width in points. Similar expressions can be obtained for sponge layers on three other ends of the domain as well as  the viscous sponge layer. 
 
The width of the sponge layer is usually taken to be two or three wave lengths for the friction-type and viscous sponge layers. Narrow sponge layers can be used for L-D type sponge layer with a good efficiency but sawtooth noises generated by the method is a concern for long-term simulation. 


\subsubsection{Periodic boundary condition}

The periodic boundary condition in y (south/north) direction was implemented in the  code. 

\subsection{Wavemaker}

\subsubsection{Internal wavemaker theory}

Internal wavemaker was implemented based on Wei and Kirby's (1999) two-way internal wavemaker and Chawla and Kirby's (2000) one-way internal wavemaker (under development). Here, we briefly summarize the formulations used in the wavemakers. Detailed theory can be found in Wei and Kirby (1999) and Chawla and Kirby (2000).    

Wei and Kirby (1999) followed the approach of Larsen and Dancy (1983) who used an ad-hoc source mechanism where water mass is added and subtracted along a straight source/sink line inside the computing domain. This approach works well in a staggered-grid differencing scheme, where water is essentially being added to or drained from a single grid block. In applying this technique to the Boussinesq model on an unstaggered grid, however, Wei and Kirby found that use of a single source line accused high frequency noise, leading to blowup of the model. They then used a partially distributed mass source $f(x,y,t)$
\be
f(x,y,t) = g(x) s(y,t)
\ee
where $g(x)$ is a Gaussian shape function and $s(y,t)$ the input time series of the magnitude of source function with an assumption that the center of the source region is parallel to the y-axis. The functions $g(x)$ and $s(y,t)$ are defined as
\be
g(x) = \mbox{exp}[-\beta(x-x_s)^2]
\ee
\be
s(y,t) = D \mbox{sin} (\lambda y -\omega t)
\label{Ssource}
\ee
where $\beta$ is the shape coefficient for the source function, and $x_s$ is the central location of the source in the $x$ direction, for a source oriented parallel to the $y$ axis, as shown in Figure \ref{wavemaker}.  $D$ is the magnitude of the source function, $\lambda = k \mbox{sin} (\theta)$ the wavenumber in the $y$ direction, and $k$ is the linear wavenumber. 

For a monochromatic wave or a single wave component of a random wave train, the magnitude $D$ of source function can be determined by
\be
D = \frac{2 a_0 \cos (\theta) (\omega^2 - \alpha_1 g k^4 h^3) }{\omega k I [1-\alpha(kh)^2]}
\label{Dmag}
\ee
where $\alpha = -0.390, \alpha_1 = \alpha + 1/3$, and $I$ is the integral given by
\be
I = \int^\infty_{-\infty} \exp (-\beta x^2) \exp (-ilx) dx = \sqrt{\frac{\pi}{\beta}} \exp(- l^2/4\beta)
\ee
where $l=k\cos (\theta)$ is the wavenumber in $x$ direction. In theory, the shape coefficient $\beta$ can be any number. The larger the value $\beta$ is, the narrower the source function becomes. The definition of the source function width $W$ is not unique, and here we define $W$ to be the distance between two coordinates $x_1$ and $x_2$ where the corresponding source function heights are equal to $\exp (-5) = 0.0067$ times the maximum height $D$. Then $x_1$ and $x_2$ must satisfy the quadratic equation
\be
\beta (x-x_s)^2 = 5
\ee
from which the width of source function is given by
\be
W = |x_2 - x_1| = 2\sqrt{\frac{5}{\beta}}
\ee
In the previous version of FUNWAVE (Kirby et al., 1998), it is suggested that $W$ equals about half of the wavelength for monochromatic wave. 
If $L$ is the wavelength, the requirement of $W=\delta L/2$ (where $\delta$ is of order 1) results in
\be
\beta = \frac{5}{(\delta L/4)^2} = \frac{80}{\delta^2 L^2}
\ee
For random waves, the value of $\beta$ is determined according to the peak frequency component and then used for all components in the wave train. FUNWAVE-TVD follows the criteria for determining $\beta$ though a narrow $W$ does not seem to cause any problem. 

\begin{figure}[htbp]
\centering
\includegraphics[width=0.8\textwidth]{./figures/wavemaker.jpg}
%\vspace{-8cm}
\caption{Source function definition in the computing domain.}
\label{wavemaker}
\end{figure}

For the irregular wavemaker, an extension was made to incorporate an  alongshore periodicity into wave generation,  in order to eliminate a boundary effect on wave simulations. The technique exactly follows the strategy in Chen et al. (2003), who adjusted the distribution of wave directions in each frequency bin to obtain alongshore periodicity. This approach is effective in modeling of  breaking wave-induced nearshore circulation such as alongshore currents and rip currents. 

\subsubsection{Regular wave generation}

The generation of monochromatic wave using the internal wavemaker is straightforward. Following the formulations given in 3.7.1, the magnitude of source function $D$ is calculated by (\ref{Dmag}) for given wave amplitude $a_0$, wave angle $\theta$, water depth $h$ and wave period. The source function can be obtained using (\ref{Ssource}). 


\subsubsection{Irregular wave generation using directional spectral data}

Irregular waves can be generated 
by integrating wave components split by frequency and direction and with random phases Each wave component contains wave amplitude $a_0$ converted from wave energy, wave angle $\theta$ and wave period. The source function for each component can be obtained using (\ref{Ssource}). 


\subsubsection{Irregular wave generation using analytical spectrum function}

The input for the wavemaker can be wave bulk parameters or directional spectral data. A TMA shallow-water spectrum and a wrapped-normal directional-spreading function are used to simulate a directional sea state. The combined spectrum function can be expressed as
\be
S(f,h,\theta) = E_{TMA}(f,h) G(\theta)
\label{tma}
\ee
In (\ref{tma}), $E_{TMA}$ is the TMA shallow-water frequency distribution as follows

\be
E_{TMA} (f,h) = \alpha g^2 f^{-5} (2 \pi)^{-4} \Phi (2\pi f, h)
e^{-5/4(f/f_p)^{-4}} \gamma^{e^{[-(f/f_p -1)^2 /2\sigma^2]}} 
\label{Etma}
\ee
in which $f_p$ is the peak frequency.  $\gamma$ presents a frequency
spreading parameter, and $\alpha$ and $\sigma$ are coefficients which
may be found in Bouws {\em et al.} (1985).  In the model,  $\alpha = 1.0$ and 
$$
\sigma = \left\{ \begin{array}{ll}
 0.07 & \mbox{if $f \leq f_p$}; \\
0.09  & \mbox{if $f > f_p$}. \end{array} \right.
$$
$\Phi$ may be expressed as
$$
\Phi (2 \pi f, h) = \left\{ \begin{array}{ll}
\frac{1}{2} \omega_h^2 & \mbox{ for $\omega_h \leq 1$}; \\
1-\frac{1}{2}(2-\omega_h)^2 & \mbox{ for $2 > \omega_h >1$};\\
1 & \mbox{for $\omega_h \geq 2$}.
\end{array} \right.
\label{phi}
$$
where 
$$
\omega_h = 2 \pi f (\frac{h}{g})^{1/2}.
$$

 

$G(\theta)$ is the wrapped normal directional spreading function written as
\be
G(\theta) = \frac{1}{2\pi} +\frac{1}{\pi} \sum^N_{n=1} e^{
[-\frac{(n\sigma_{\theta})^2}{2}]} \cos n\theta 
\ee
where $\sigma_{\theta}$ denotes circular deviation of the wrapped normal
spreading function. To avoid the computational underflow, $N =
20$ in the model.

In the TMA wavemaker, the directional spectrum is divided into $2100$ components with random
phases and equal energy at each frequency block. The source function technique
(Wei, {\em et al.}, 1999) is then used for each component and the final
surface elevation function can be written as
\be
\eta = \sum^M_{m=1} C_m \cos \omega _m t + \sum^M_{m=1} S_m \sin \omega _m t
\ee
where
\ba
C_m &=& \sum^k_{n=1} D_{mn} \cos (k_{mn}y + \varepsilon_{mn}) \\
\nonumber
S_m &=& \sum^k_{n=1} D_{mn} \sin (k_{mn}y + \varepsilon_{mn})
\ea
in which $y$-axis is oriented along the
main axis of the wave maker. $D_{mn}, k _{mn}$ and
$\varepsilon_{mn}$ are respectively the amplitude, wave number in the $y$ direction and phase of a
component. The phase can be random. 


\subsection{Other implementations}

\subsubsection{Wind effect}
Wind effects are modeled using the wind stress forcing proposed by Chen et al. (2004). The wind stress is expressed by
\be
{\bf R}_w = \frac{\rho_a}{\rho} C_{dw} |{\bf U}_{10} - {\bf C}| ({\bf U}_{10} - {\bf C})
\ee
where $\rho_a$ and $\rho$ represent air density and  water density, respectively, $\bf C$ is wave celerity.  The wind stress is only applied on wave crests. A free parameter representing a ratio of the forced crest height to maximum surface elevation is implemented in the model. 

\subsubsection{Wave height calculation}

For spectral wave simulations, both average wave height and root-mean-square wave height are calculated using zero-crossing at each grid point. Significant wave height is evaluated using Goda's (2000) formula
\be
H_{1/3} = 4.004\sqrt{m_0}
\label{qoda}
\ee 
where
\be
m_0 = \frac{1}{t_2-t_1} \int^{t_2}_{t_1} \eta^2 dt
\label{m0}
\ee

\subsection{Parallelization}

In parallelizing the computational model, we used a domain decomposition technique to subdivide the problem into multiple regions and assign each subdomain to a separate processor core. Each 
subdomain region contains an overlapping area of ghost cells,  three-row deep, as required by the fourth order MUSCL-TVD scheme. The Message Passing Interface (MPI) with non-blocking communication is used to exchange  data in the overlapping region between neighboring processors. 
 Velocity components are obtained 
from Equation (\ref{eq22}),  by solving tridiagonal matrices using the parallel pipelining 
tridiagonal solver described in Naik et al. (1993). 

%To investigate performance of the parallel program, numerical simulations of an 
%idealized  case are tested with different numbers of processors  on a Linux cluster located at University of Delaware. 
%The test case is set up in a numerical grid  of 1800 $\times$ 1800 cells.  
%Figure \ref{fig1} shows the model speedup versus number of processors. It can be seen that performance scales nearly proportional to the number of processors, with some delay caused by inefficiencies in parallelization, such as inter-processor communication time.

%\begin{figure}[htbp]
%\centering
%\includegraphics[width=0.8\textwidth]{./figures/speedup.pdf}
%\caption{Variation in model performance with number of processors for a 1800 x 1800 domain.  Straight line indicates %arithmetic speedup. Actual performance is shown in the curved line.}
%\label{fig1}
%\end{figure}


\section{Users' Manual}

\subsection{Program outline and flow chart}

The code was written using Fortran 90 with the c preprocessor (cpp) statements for separation of the source code. Arrays are dynamically allocated at runtime. Precision is selected using the {\em selected\_real\_kind} Fortran intrinsic function defined in the makefile.  The default precision is single. 

The present version of FUNWAVE-TVD includes a number of options including: choice of serial or parallel code; Cartesian or spherical coordinate (Tsunami propagation mode); samples; one-way nesting mode;  wave breaking index and aging (bubble and foam mode); different bottom friction formulas and etc.

The flow chart is shown in Figure {\ref{chart}}. 

\begin{figure}[htbp]
	\centering
		\includegraphics[width=0.8\textwidth]{./figures/chart.pdf}
	\caption{Flow chart of the main program (Note, the ITERATION option is not used any more).}
	\label{chart}
\end{figure}

Note that, ``ITERATION" described in Shi et al. (2011, 2012a,b) is not used any more. The Range-Kutta  time stepping with combined CLF criteria  is found to be more efficient than the iteration method. 

\subsection{Installation and compilation}

FUNWAVE-TVD is distributed in a compressed fie. To install the programs, first, uncompress the package. Then use 

$>$ tar xvf *.tar 

\noindent
to extract files from the uncompressed package. The exacted files will be distributed in two new directories: /src and /work.

To compile the program, go to /src and modify Makefile if needed. There are several necessary flags in Makefile needed to specify below.

\begin{description} 

\item -DDOUBLE\_PRECISION: use double precision, default is single precision.

\item -DPARALLEL: use parallel mode, default is serial mode.

\item -DSAMPLES: include all samples, default is no sample included.

\item -DCARTESIAN: Cartesian version, otherwise Spherical version

\item -DINTEL: if INTEL compiler is used, this option can make use of FPORT for the RAND() function

\item -DCRAY: for CRAY RAND() and system commands


\item -DMIXING: include Smagorinsky mixing. 

\item -DCOUPLING: nesting mode.

\item -DMANNING: Using Manning coefficient for friction calculation.


\item CPP: path to CPP directory.

\item FC: Fortran compiler. 

\end{description}

Note: -DSAMPLES should be set on in all cases when you are doing any surface wave case. 

Then execute 

$>$ make

\noindent
The executable file such as `funwave' or 'mytvd' will be generated and  copied from /src to /work/. If you do not find 'funwave' in your /work/, go to /src/ to find the newest executable file and copy it to your /work/ directory.  Note: use `make clean' after modifying Makefile.  

To run the model, go to /work. Modify input.txt if needed and run. 


\subsection{Input}

Following are descriptions of parameters in input.txt
({\bf  NOTE: }  all parameter names are capital sensitive).

 \begin{description}
 
\item {\bf TITLE:}   title of your case, only used for log file. 

\item {\bf SPECIFICATION OF HOT START}

\item HOT\_START:  logical parameter, T for hot start, F for cold start. Note that hot start in the present version is not available. However, a user can use the option INI\_UVZ to restart the model. For this mode, time derivative terms are ignored at the hot start. 

\item FileNumber\_HOTSTART: number of hotstart file used for a hot start, e.g., 1,2, ...

\item {\bf SPECIFICATION OF MULTI-PROCESSORS}

\item PX:  processor numbers in X
\item PY :  processor numbers in Y \\
 {\bf NOTE:} PX and PY must be consistency with number of processors defined in mpirun command, e.g., 
mpirun -np n (where n = px$\times$py). PX (PY) should be a common factor of Mglob(Nglob) in the present version.   

 
 \item {\bf SPECIFICATION OF WATER DEPTH}
 
 \item DEPTH\_TYPE: depth input type. 
 
   DEPTH\_TYPE=DATA: from a depth file. 
   
   The program includes several simple bathymetry configurations such as
   
                DEPTH\_TYPE=FLAT:  flat bottom, need DEPTH\_FLAT 
                
                DEPTH\_TYPE=SLOPE:  plane beach along $x$ direction. It needs three parameters:
                                    slope,SLP,  slope starting point, Xslp
                                   and flat part of depth, DEPTH\_FLAT

\item  DEPTH\_FILE: bathymetry file if  DEPTH\_TYPE=DATA, file dimension should be Mglob x Nglob with the first point as the south-west corner.  The read format in the code is shown below.

       DO J=1,Nglob
       
        READ(1,*)(Depth(I,J),I=1,Mglob)
        
       ENDDO
 
\item DEPTH\_FLAT: water depth of flat bottom if DEPTH\_TYPE=FLAT or DEPTH\_TYPE=SLOPE (flat part of a plane beach).
 
\item SLP: slope if DEPTH\_TYPE=SLOPE

\item Xslp: starting $x$ (m) of a slope, if DEPTH\_TYPE=SLOPE


 \item {\bf SPECIFICATION OF RESULT FOLDER}  
  
\item RESULT\_FOLDER: result folder name, e.g., RESULT\_FOLDER = /Users/fengyanshi/tmp/

 \item {\bf SPECIFICATION OF DIMENSION}

\item Mglob: global dimension in $x$ direction.

\item Nglob: global dimension in $y$ direction.

 \item {\bf SPECIFICATION OF TIME}
 
\item TOTAL\_TIME: simulation time in seconds

\item PLOT\_INTV: output interval in seconds (Note, output time is not exact because adaptive dt is used.)

\item SCREEN\_INTV: time interval (s) of screen print. 

\item PLOT\_INTV\_STATION: time interval (s) of gauge output

 \item {\bf SPECIFICATION OF GRID SIZE}

\item DX: grid size(m) in $x$ direction.

\item DY:   grid size(m) in $y$ direction.

 \item {\bf SPECIFICATION OF INITIAL CONDITION}
 
 \item INT\_UVZ : logical parameter for initial condition, default is FALSE
 
 
\item ETA\_FILE: name of file for initial $\eta $, e.g., ETA\_FILE= /Users/fengyanshi/work/input/CVV\_H.grd, data format is the same as depth data.

\item U\_FILE:  name of file for initial $u$, e.g.,U\_FILE= /Users/fengyanshi/work/input/CVV\_U.grd, data format is the same as depth data.

\item V\_FILE:  name of file for initial $v$, e.g., V\_FILE= /Users/fengyanshi/work/input/CVV\_V.grd, data format is the same as depth data.

\item MASK\_FILE:  name of file for initial MASK, e.g., MASK\_FILE= /Users/fengyanshi/work/input/CVV\_MASK.grd, data format is the same as depth data. Usually a MASK\_FILE is from a model output and the format is REAL numbers. If there is no MASK\_FILE, MASK values will be re-specified according to ETA and DEPTH.  

 \item {\bf SPECIFICATION OF WIND EFFECT}
 
 \item WindForce: logical parameter representing if wind effect is taken into account. T or F. Note: spatially uniform wind field is assumed in this version.   

\item WIND\_FILE: file name for wind data. The following is an example of data format.

wind data

100  - number of data

0.0 ,    10.0 0.0   ---  time(s), wu, wv (m/s)

2000.0,   10.0,  0.0

8000.0,  10.0,   0.0
 
... 


\item Cdw: wind stress coefficient for the quadratic formula. 

\item WindCrestPercent: ratio of the forced wave crest height to the maximum surface elevation. 

 \item {\bf SPECIFICATION OF WAVEMAKER}

\item WAVEMAKER: wavemaker type. 

WAVEMAKER = INI\_REC: initial rectangular hump, need  Xc,Yc and WID

WAVEMAKER = LEF\_SOL: left boundary solitary, need AMP,DEP, and LAGTIME

WAVEMAKER = INI\_SOL: initial solitary wave, WKN B solution, need AMP, DEP, and XWAVEMAKER 

WAVEMAKER = INI\_OTH:  other initial distribution specified by users

WAVEMAKER = WK\_REG: Wei and Kirby 1999 internal wave maker, need Xc\_WK, Yc\_WK, Tperiod, AMP\_WK, DEP\_WK, Theta\_WK, and Time\_ramp (factor of period)

WAVEMAKER = WK\_IRR:  Wei and Kirby 1999 TMA spectrum wavemaker, need Xc\_WK, Yc\_WK,
           DEP\_WK, Time\_ramp, Delta\_WK,  FreqPeak, FreqMin,FreqMax,
            Hmo, GammaTMA, ThetaPeak

WAVEMAKER = WK\_TIME\_SERIES: {\em fft} a time series to get each wave component
                 and then use Wei and Kirby's ( 1999) wavemaker.  The wave angle is zero (x direction) for all wave components.
           Need input WaveCompFile (including 3 columns: per,amp,pha) and 
            NumWaveComp,PeakPeriod,DEP\_WK, Xc\_WK,Ywidth\_WK
 
WAVEMAKER = WAVE\_DATA:  2D directional spectrum data specified in WaveCompFile. Need Xc\_WK, Yc\_WK,
           DEP\_WK, Delta\_WK. See WaveCompFile for file format. 
            
WAVEMAKER = GAUSIAN: initial Gausian hump, need AMP, Xc, Yc, and WID.          

\item WaveCompFile: Wave component file when    WAVEMAKER = WAVE\_DATA is selected.  The format is

nfreq(integer) ndir(integer) \\
peak\_freq (real) \\
freq1(real) \\
freq2(real) \\
... \\
dir1(real, in degrees) \\
dir2(real, in degrees) \\
... \\
2D array of wave magnitude ((amp(I,J),I=1,ndir),J=1,nfreq)



\item AMP: amplitude (m) of initial $\eta$, if  WAVEMAKER = INI\_REC, WAVEMAKER = INI\_SOL, WAVEMAKER = LEF\_SOL.

\item DEP: water depth at wavemaker location, if WAVEMAKER = INI\_SOL, WAVEMAKER = LEF\_SOL.

\item LAGTIME, time lag (s) for the solitary wave generated on the left boundary, e.g., WAVEMAKER = LEF\_SOL. 
 
\item XWAVEMAKER: $x$  (m) coordinate for WAVEMAKER = INI\_SOL.


\item Xc: $x$ (m) coordinate of the center of  a rectangular hump if WAVEMAKER = INI\_REC.

\item Yc: $y$ (m) coordinate of the center of  a rectangular hump if WAVEMAKER = INI\_REC.

\item WID: width (m) of  a rectangular hump if WAVEMAKER = INI\_REC, or INI\_GAU.


\item Time\_ramp: time ramp (s) for Wei and Kirby (1999) wavemaker. 
 
\item Delta\_WK:  width parameter $\delta$  for Wei and Kirby (1999) wavemaker.    $\delta$ =  $0.3 \sim 0.6$

\item DEP\_WK: water depth (m) for Wei and Kirby (1999) wavemaker.

\item Xc\_WK: $x$ coordinate (m) for Wei and Kirby (1999) wavemaker.

\item Ywidth\_WK: width (m) in $y$ direction for Wei and Kirby (1999) wavemaker.

\item Tperiod:  period (s) of regular wave for Wei and Kirby (1999) wavemaker.

\item AMP\_WK: amplitude (m) of regular wave for Wei and Kirby (1999) wavemaker.

\item Theta\_WK: direction (degrees) of regular wave for Wei and Kirby (1999) wavemaker. Note: it may be adjusted for a periodic boundary case by the program. A warning will be given if adjustment is made. 
 
\item FreqPeak: peak frequency (1/s) for Wei and Kirby (1999) irregular wavemaker.

\item FreqMin: low frequency cutoff (1/s) for Wei and Kirby (1999) irregular wavemaker.
 
\item FreqMax: high frequency cutoff (1/s) for Wei and Kirby (1999) irregular wavemaker.

\item Hmo: Hmo (m) for Wei and Kirby (1999) irregular wavemaker.

\item GammaTMA, TMA parameter $\gamma$ for Wei and Kirby (1999) irregular wavemaker.

\item ThetaPeak: peak direction (degrees) for Wei and Kirby (1999) irregular wavemaker. 

\item Sigma\_Theta: parameter of directional spectrum for Wei and Kirby (1999) irregular wavemaker.

\item {\bf SPECIFICATION OF PERIODIC BOUNDARY CONDITION} 

( Note: only south-north periodic condition was implemented, ONLY FOR SERIAL CODE IN THE PRESENT VERSION.)

\item PERIODIC: logical parameter for periodic boundary condition, T - periodic, F - wall boundary condition.


\item {\bf SPECIFICATION OF SPONGE LAYER} 
 
 \item DIRECT\_SPONGE: logical parameter for L-D type sponge, T - sponge layer, F - no sponge layer.
 
  \item FRICTION\_SPONGE: logical parameter for friction type sponge, T - sponge layer, F - no sponge layer.
 
  \item DIFFUSION\_SPONGE: logical parameter for diffusion type sponge, T - sponge layer, F - no sponge layer.
 
 \item Csp: The maximum diffusion coefficient for diffusion type sponge.
 
 \item CDsponge: The maximum Cd for friction type sponge.
 
\item Sponge\_west\_width: width (m) of sponge layer at west boundary.

\item Sponge\_east\_width:   width (m) of sponge layer at east boundary.

\item Sponge\_south\_width: width (m) of sponge layer at south boundary.

\item Sponge\_north\_width width (m) of sponge layer at north boundary

\item R\_sponge: decay rate in L-D type sponge layer. Its values are between 0.85 $\sim$ 0.95.

\item A\_sponge: maximum damping magnitude in L-D type sponge. The value is $\sim$ 5.0. 

\item {\bf SPECIFICATION OF OBSTACLES} 

\item OBSTACLE\_FILE: name of obstacle file. 1 - water point, 0 - permanent dry point. Data dimension is (Mglob $\times$ Nglob). Data format is the same as the depth data. 
 
 \item {\bf SPECIFICATION OF PHYSICS} 
  
\item DISPERSION: logical parameter for inclusion of dispersion terms.  T - calculate dispersion, F - no dispersion terms

\item Gamma1: parameter for linear dispersive terms. 1.0 - inclusion of linear dispersive terms, 0.0 - no linear dispersive terms. 

\item Gamma2: parameter for nonlinear dispersive terms. 1.0 - inclusion of nonlinear dispersive terms, 0.0 - no nonlinear dispersive terms. 

  Gamma1=1.0, Gamma2=0.0 for  NG's equations.
  Gamma1=1.0, Gamma2=1.0 for the fully nonlinear Boussinesq equations.
  
\item Gamma3: parameter for linear shallow water equations (Gamma3 = 1.0). When Gamma3 = 0.0, Gamma1 and Gamma2 automatically become zero.   

\item Beta\_ref:  parameter $\beta$ defined for the reference level. $\beta$ = -0.531 for NG's and FUNWAVE equations.

\item VISCOSITY\_BREAKING : logical parameter for viscous breaking. When this option is selected, Cbrk1 and Cbrk2 needed. Default is shock-capturing type breaking

\item SWE\_ETA\_DEP: ratio of height/depth for switching from Boussinesq to NSWE for shock-capturing breaking.  The value is $\sim$ 0.80. 

 \item {\bf SPECIFICATION OF FRICTION} 
  
\item FRICTION\_MATRIX: logical parameter for homogeneous and inhomogeneous frction feild.  T - inhomogeneous, F - homogeneous

\item FRICTION\_FILE: file file if  FRICTION\_MATRIX= T , file dimension should be Mglob x Nglob with the first point as the south-west corner.  The read format in the code is shown below.

       DO J=1,Nglob
       
        READ(1,*)(Cd(I,J),I=1,Mglob)
        
       ENDDO
\item Cd\_fixed: fixed bottom friction coefficient.

\item {\bf SPECIFICATION OF NUMERICS} 


\item Time\_Scheme: stepping option,  Runge\_Kutta or Predictor\_Corrector (not suggested for this version).

\item HIGH\_ORDER: spatial scheme option,  FOURTH for the fourth-order, THIRD for the third-order, and SECOND for the second-order (not suggested for Boussinesq modeling). NOTE:  Abadie et al. (2012) pointed out that the fourth-order TVD scheme in RUNWAVE-TVD has an stability problem for simulations in deep water. We also encountered the similar problem in some cases. For this reason, the third-order  scheme is suggested for the present version. 

SM Abadie, JC Harris, ST Grilli, R Fabre, 2012, Numerical modeling of tsunami waves generated by the flank collapse of the Cumbre Vieja Volcano (La Palma, Canary Islands): Tsunami source and near field effects, Journal of Geophysical Research: Oceans (19782012) 117 (C5)

\item CONSTRUCTION: construction method,  HLL for HLL scheme, otherwise for averaging scheme.

\item CFL: CFL number, CFL $\sim$ 0.5.

\item FroudeCap: cap for Froude number in velocity calculation for efficiency. The value could be 5 $\sim$ 10.0.

\item MinDepth: minimum water depth (m) for wetting and drying scheme. Suggestion: MinDepth = 0.001 for lab scale and 0.01 for field scale. 

\item MinDepthFrc: minimum water depth (m) to limit bottom friction value. Suggestion: MinDepthFrc = 0.01 for lab scale and 0.1 for field scale. 

\item SHOW\_BREAKING: logical parameter to calculate breaking index. Note that, if VISCOSITY\_BREAKING is not selected,  breaking is calculated using shock wave capturing scheme. The index calculated here is based on Kennedy et al. (2000). 

\item Cbrk1: parameter C1 in Kennedy et al. (2000).  

\item Cbrk2:  parameter C2 in Kennedy et al. (2000).

\item WAVEMAKER\_Cbrk: breaking parameter inside wavemaker. For some cases, wave breaks inside the wavemaker. This parameter provides Cbrk inside the wavemaker domain. For most of cases, set WAVEMAKER\_Cbrk = Cbrk1 or higher. 

\item STEADY\_TIME: starting time ($t_1$ in (\ref{m0})) for calculating mean values, significant/RMS wave height (when WaveHeight = T, output parameter below).

\item T\_INTV\_mean: time interval ($t_2-t_1$ in (\ref{m0})) for calculating mean values, significant/RMS wave height (when WaveHeight = T, output parameter below).


\item {\bf SPECIFICATION OF OUTPUT VARIABLES}

\item NumberStations: number of station for output. If NumberStations $> 0$, need input i,j in STATION\_FILE
 
\item DEPTH\_OUT: logical parameter for output depth. T or F. 
\item U: logical parameter for output $u$. T or F. 
\item  V: logical parameter for output $v$. T or F. 
\item ETA: logical parameter for output $\eta$. T or F. 
\item MASK: logical parameter for output wetting-drying MASK. T or F. 
\item MASK9: logical parameter for output MASK9 (switch for Boussinesq/NSWE). T or F. 
\item SourceX: logical parameter for output source terms in $x$ direction. T or F. 
\item SourceY:  logical parameter for output source terms in $y$ direction. T or F. 
\item P:   logical parameter for output of  momentum flux in $x$ direction. T or F. 
\item Q:  logical parameter for output of  momentum flux in $y$ direction. T or F. 
\item Fx: logical parameter for output of numerical flux F in $x$ direction. T or F. 
\item  Fy: logical parameter for output of numerical flux F in $y$ direction. T or F. 
\item Gx: logical parameter for output of numerical flux G in $x$ direction. T or F. 
\item Gy: logical parameter for output of numerical flux G in $y$ direction. T or F. 
\item AGE: logical parameter for output of breaking age. T or F. 
\item HMAX: logical parameter for output of recorded maximum surface elevation . T or F. 
\item HMIN: logical parameter for output of recorded minimum surface elevation . T or F. 
\item UMAX: logical parameter for output of recorded maximum velocity . T or F. 
\item VORMAX: logical parameter for output of recorded maximum vorticity . T or F. 
\item MFMAX: logical parameter for output of recorded maximum momentum flux . T or F. 
\item WaveHeight: logical parameter for output of wave height, Hsig, Hrms, Havg. T or F.


\end{description}

\subsection{Input for the spherical code}

All input parameters, except the following grid information, are the same as for the Cartesican code.

\begin{description}

\item Lon\_West: longitude (degrees) of west boundary.
\item Lat\_South: latitude (degrees) of south boundary.
\item Dphi: $d\phi$ (degrees)
\item Dtheta: $d\theta$ (degrees) 

\end{description}

In addition, it is not necessary to specify  Gamma2 (for nonlinear dispersive terms) in the spherical code.  

Another feature of the spherical code is that a computational grid can be a stretched grid. For a stretched grid, a user should set  StretchGrid = T and provide grid files for DX and DY and a file for Coriolis parameters at each grid point.  For example,

DX\_FILE = dx\_str.txt

DY\_FILE = dy\_str.txt

CORIOLIS\_FILE = cori\_str.txt

However, use of a stretched grid is not recommended in terms of decrease in numerical accuracy for  higher order numerical schemes. 

\subsection{Model nesting}

The present version has a capability for one-way nesting. The nesting scheme passes surface elevation and velocity components calculated from a large domain to a nested small domain through ghost cells at nesting boundaries. To run a nested model, the following procedures should be performed.

\begin{enumerate}

\item The coupling option in Makefile should be defined as '-Dcoupling''. The program should be re-compiled.

\item Prepare nesting data using the output of a large-domain model. The following is an example of the data format.

coupling data\\
 boundary info: num of points (negative means no point), start point \\
 EAST \\
          -1    \ \ \       1  \ \ ({\em no data on east side})\\
 WEST \\
           5   \ \ \        1  \ \ ({\em 5 points at west boundary, start from  1}) \\
 SOUTH \\
          -1   \ \ \        0  \ \ ({\em no data on south side}) \\
 NORTH \\
          -1   \ \ \        0  \ \ ({\em no data on north side}) \\
 TIME SERIES \\
   68.443001    ({\em first step, NOTE: model clock will be initialized as this time}) \\
 EAST SIDE  ({\em no nesting on east side})\\
 WEST SIDE \\
    0.141220E-02 \ \   0.141220E-02  \ \  0.141220E-02  \ \  0.141220E-02  \ \  0.141220E-02 ({\em u}) \\
   -0.119260E-10 \ \   -0.119260E-10 \ \  -0.667390E-10  \ \  -0.667390E-10  \ \  -0.219240E-10 ({\em v}) \\
    0.141890E-02  \ \   0.141890E-02  \ \  0.141890E-02  \ \  0.141890E-02  \ \  0.141890E-02   ({\em z}) \\
 SOUTH SIDE ({\em no nesting on south side}) \\
 NORTH SIDE ({\em no nesting on north side}) \\
   68.641998    ({\em next time step}) \\
   ...\
           
The example above is a case that a model nesting  takes place at the WEST (left) boundary of a small domain.   Boundaries are defined with the order: EAST, WEST, SOUTH, and NORTH. If the num of points of a boundary is larger than zero, the program will read a time series of ($u$, $v$, $\eta$) below 'XXXX SIDE'. The read format is

             READ(11,*) TIME\_COUPLING\_2 \\
             READ(11,119)(U\_COUPLING\_EAST(I,2),I=1,N\_COUPLING\_EAST)\\
             READ(11,119)(V\_COUPLING\_EAST(I,2),I=1,N\_COUPLING\_EAST)\\
             READ(11,119)(Z\_COUPLING\_EAST(I,2),I=1,N\_COUPLING\_EAST)\\
           ENDDO \\          
119      FORMAT(5E16.6) 
           
where N\_COUPLING\_EAST is Num of points at the EAST boundary.
       
 
\item Specify the file of coupling data in input.txt

  ! ----------------- COUPLING -------------------------\\
  ! if do coupling, have to set -DCOUPLING in Makefile \\
COUPLING\_FILE = coupling.txt \\
where 'coupling.txt' is the file saved in procedure 2. 

\end{enumerate}
 

\subsection{Output}
The output files are saved in the result directory defined by RESULT\_FOLDER in input.txt. For outputs in ASCII,  a file name is a combination of variable name and an output series number such eta\_00001, eta\_00002, .... The format  and read/write algorithm are  consistent with a depth file.  Output for stations is a series of numbered files such as sta\_00001, sta\_00002 .... 

Other output formats are under development. 

\section{Examples}

The model has been validated extensively using laboratory experiments for wave shoaling and breaking as in the FUNWAVE manual by Kirby et al. (1998). In addition, Tehranirad et al. (2011) used FUNWAVE-TVD Version 1.0 to carry out tsunami benchmark testing in conjunction with the National Tsunami Hazard Mitigation Program. Tests of mass conservation and convergence are included in Tehranirad et al. (2011). 


\subsection{Breaking waves on a beach }

Hansen and Svendsen (1979) carried out laboratory experiments of wave shoaling and breaking on a beach.  Waves were generated on a flat bottom a 0.36 m depth, and the  beach slope was 1:34.26.  The experiments included several cases including plunging breakers, plunging-spilling breakers and spilling breakers.  In this manual, we simulate  the plunging breaker case as a demonstration. The wave height and wave period are  4.3 cm and 3.33 s, respectively. 

 We  adopted a grid size, dx = 0.025 m in the present case. Shi et al. (2011) also showed simulations in different grid sizes and verified a convergence with grid refinement. To compare two different breaking algorithms we conducted runs with the shock-capturing breaking method and the eddy-viscosity breaking method, respectively. Figure \ref{fig2} shows comparisons of wave height and wave setup between measured data and numerical results from model runs with different breaking algorithms. The wave breaking location of wave setup/setdown predicted by the two runs are in agreement with the data. 
  However,  
the predicted maximum wave heights are slightly different.  Basically, the two models underpredict the peak wave height at breaking and overpredict wave height inside of the surfzone.  For the eddy-viscosity type breaking, we adopted Cbrk1 =0.65 and Cbrk2=0.15, which are default values from Kennedy et al and this model. The modeled mean water level is slightly lower than the measurement at the toe of the beach (x=0 m)  due to the mass conservation in the limited length of computational domain. 

Some necessary definitions  in the input file, input.txt, for the plunging breaker case are

\vspace*{0.5cm}
  ! --------------------DEPTH-------------------------------------\\
DEPTH \_TYPE = SLOPE\\
DEPTH \_FLAT = 0.36  \\
SLP = 0.0292\\
Xslp = 30.0\\

  ! -------------------PRINT--------------------------------- \\
RESULT\_FOLDER = your output folder \\

  ! ------------------DIMENSION-----------------------------\\
Mglob = 2000\\
Nglob = 3\\
  ! ----------------- TIME----------------------------------\\
DX = 0.025\\
DY = 0.2   ! give any larger value than DX for 1-D case \\
  ! ----------------WAVEMAKER------------------------------\\
 WAVEMAKER = WK \_REG\\
  Xc \_WK = 45.0\\
Tperiod = 3.33\\
AMP \_WK = 0.018   ! this value is smaller than the report of Hansen and Svendsen, but matches the measured data \\  
DEP \_WK = 0.36\\
Theta \_WK = 0.0\\
Delta \_WK = 0.5 \\
  ! ---------------- SPONGE LAYER ------------------------\\
 DIRECT \_SPONGE = T\\
Sponge \_west \_width = 12.0\\
Sponge \_east \_width =  0.0\\
Sponge \_south \_width = 0.0\\
Sponge \_north \_width = 0.0\\
R \_sponge = 0.85\\
A \_sponge = 5.0 \\
  ! ----------------PHYSICS------------------------------\\
 DISPERSION = T\\
Gamma1 = 1.0\\
Gamma2 = 1.0\\
Gamma3=1.0\\
Beta \_ref=-0.531\\
  !----------------breaking----------------------------- \\
SWE \_ETA \_DEP = 0.8\\
VISCOSITY\_BREAKING = F  !  switch to T for the other case \\
Cbrk1 = 0.65 \\
Cbrk2 = 0.15 \\
WAVEMAKER\_Cbrk = 0.65 \\

  !----------------Friction----------------------------- \\
Friction\_Matrix=F \\
Cd\_file= cd.txt  \\
Cd = 0.0    !  Cd is not sensitive for this case\\
  ! ----------------NUMERICS----------------------------\\
  Time \_Scheme = Runge \_Kutta\\
  HIGH \_ORDER = THIRD\\
  CONSTRUCTION = HLLC\\
CFL = 0.5\\
  ! --------------WET-DRY-------------------------------\\
  MinDepth=0.001\\
  MinDepthFrc = 0.001\\
  ! -----------------OUTPUT-----------------------------\\
  NumberStations = 119 \\
STATIONS\_FILE = gauge.txt \\  
  DEPTH \_OUT = T\\
  ETA = T\\
MASK = T\\

%A MATLAB script, {\em plot\_surface\_ele.m}, is used for plots. 

\begin{figure}[htbp]
\centering
\includegraphics[width=0.8\textwidth]{./figures/hansen_svendsen.pdf}
\caption{Comparisons of wave height (upper panel) and wave setup (lower panel) between measured data and model results.}
\label{fig2}
\end{figure}



\subsection{Random wave shoaling and breaking on a slope  (in directory $/$mase$\_$kirby$\_$1d$/$) }

To study random-wave properties of shoaling and breaking, Mase and Kirby (1992) conducted a laboratory experiment of random wave propagation over a planar beach. The experiment layout is shown in Figure \ref{fig5}, where a constant depth of 0.47 m on the left connects to a constant slope of 1:20 on the right. Two sets of random waves with peak frequencies of 0.6 Hz (run 1) and 1.0 Hz (run 2) were generated by the wavemaker on the left. The target incident spectrum was a Pierson-Moskowitz spectrum. Wave gauges at depths $h$ = 47, 35, 30, 25, 20, 17.5, 15, 12.5, 10, 7.5, 5, and 2.5 cm collected time series of surface elevation. 

Wei and Kirby (1995) carried out a simulation of run 2 without wave breaking. Later, Kirby et al. (1998) and Kennedy et al. (2000) carried out the same simulation  with  wave breaking.  The present model was set up following Kirby et al. (1998), who used an internal wavemaker located at the toe of the slope where surface elevation is measured (gauge 1). 

A {\em FFT} was used to  transform between the time domain and frequency domain data required by the wavemaker. A MATLAB script, ({\em fft4wavemaker.m }) to perform this transform is included in the example.  The script reads the measured data from the file called {\em r2d470.dat}, and saves calculated wave amplitude, period and phase information for each component in the file named as {\em wavemk\_per\_amp\_pha.txt}. 
The low and high-frequency cutoffs are 0.2 and 10.0 Hz, respectively. 

The simulation time is the same as the time length of data collection. The computational domain is from x = 0 m to 20 m with a grid size of  0.04 m. The toe of the slope starts at x = 10 m. A sponge layer is specified  at the left side boundary,  to absorb reflected waves, but no sponge layer is needed on the right boundary, which differs  from Kirby et al. (1998) who used the slot method combined with a sponge layer at the end of the domain.      

We present the model results for run 2 and compare with the experimental data measured at the other 11 gauges  shown in Figure \ref{fig5}.  Figure \ref{fig6} shows model results (dashed lines) and measured data (solid lines) from $ t$ = 20 s to $t $ = 40 s at those gauges.   Both model and data show that most waves start breaking at the depth $h $= 15 cm.  Except for small discrepancies for wave phases, the model reproduces the measured waveform quite well. 

To further demonstrate the applicability of the model, we performed third moment computations of  the resulting time series of surface elevation. Normalized wave skewness and asymmetry were calculated for both measured and modeled time series of surface elevation according to the following formulations,
\ba
\mbox{skew} &= &  \frac{ < \eta^3>}{<\eta^2>^{3/2}} \nonumber \\
\mbox{asym} &=&  \frac{<H(\eta)^3>}{<\eta^2>^{3/2}}
\ea
where $H$ denotes the Hilbert transform, $< >$ is the mean operator, and the mean has been removed from the time series of surface elevation. 

Figure \ref{fig7} shows the comparisons of skewness and asymmetry between the model results and experiment data. The model predicted skewness and asymmetry reasonably well with a slightly overprediction of wave skewness inside the surf zone. 

It is worth mentioning that  Kirby et al. (1998) employed more frequent use of numerical filtering, especially after wave breaking, so that the model run was stable over the entire data time series.  The present model did not encounter any stability problem without filtering. 

\begin{figure}[htbp]
\centering
\includegraphics[width=0.8\textwidth]{./figures/mase_kirby_layout.pdf}
\caption{Experiment layout of Mase and Kirby (1992).}
\label{fig5}
\end{figure}

\begin{figure}[htbp]
\centering
\includegraphics[width=0.8\textwidth]{./figures/mase_kirby_ele.pdf}
\caption{Time series comparison of $\eta$ between model (dashed lines) and data (solid lines) at 11 wave gauges in Mase and Kirby (1992).}
\label{fig6}
\end{figure}

\begin{figure}[htbp]
\centering
\includegraphics[width=0.8\textwidth]{./figures/mase_kirby_skew.pdf}
\caption{Comparison of skewness ($\circ$) and asymmetry ($\times$) at different water depths. Solid lines are experiment data ( Mase and Kirby, 1992). Dashed lines are numerical results}
\label{fig7}
\end{figure}

Some necessary definitions  in the input file, input.txt,  are

\vspace{0.5cm}
  ! --------------------DEPTH------------------------------------- \\
DEPTH\_TYPE = SLOPE \\
DEPTH\_FLAT = 0.47\\
SLP = 0.05\\
Xslp = 10.0\\

  ! ------------------DIMENSION-----------------------------\\
Mglob = 500\\
Nglob = 3\\

  ! ----------------- TIME----------------------------------\\
TOTAL\_TIME = 716.0\\
PLOT\_INTV = 10.0\\
PLOT\_INTV\_STATION = 0.05\\
SCREEN\_INTV = 1.0\\

  ! -----------------GRID----------------------------------\\
DX = 0.04\\
DY = 0.10\\

  ! ----------------WAVEMAKER------------------------------\\
WAVEMAKER = WK\_TIME\_SERIES\\
NumWaveComp = 1505\\
PeakPeriod = 1.0\\
WaveCompFile = ../fft/wavemk\_per\_amp\_pha.txt\\
  ! Wei and Kirby 1999\\
Time\_ramp = 1.0 \\
Delta\_WK = 0.4    ! width parameter 0.3-0.6\\
DEP\_WK = 0.47\\
Xc\_WK = 10.0\\
Ywidth\_WK = 10000.0  ! give any bigger value than the width of tank\\

  ! ---------------- SPONGE LAYER ------------------------\\
DIRECT \_SPONGE = T\\
Sponge\_west\_width =  2.0\\
Sponge\_east\_width =  0.0\\
Sponge\_south\_width = 0.0\\
Sponge\_north\_width = 0.0\\
R\_sponge = 0.90\\
A\_sponge = 5.0\\

  ! ----------------PHYSICS------------------------------\\
DISPERSION = T\\
Gamma1 = 1.0\\
Gamma2 = 1.0\\
Gamma3 = 1.0\\
Beta\_ref=-0.531\\
SWE\_ETA\_DEP = 0.80\\
Cd = 0.001   ! not sensitive for this case\\
  
  ! ----------------NUMERICS----------------------------\\
Time\_Scheme = Runge\_Kutta\\
HIGH\_ORDER = THRID\\
CONSTRUCTION = HLLC\\
CFL = 0.5\\
  ! --------------WET-DRY-------------------------------\\
MinDepth=0.001\\
MinDepthFrc = 0.001\\
  ! -----------------OUTPUT-----------------------------\\
NumberStations = 12\\
STATIONS\_FILE = gauges\_004.txt\\
DEPTH\_OUT = T\\
ETA = T\\

Model output at 12 gauges are saved in {\em sta\_0001, sta\_0002, ..., sta\_0012}. Use MATLAB scripts, {\em comp\_mkskew.m} and {\em cmop\_series.m} for plots. 

\subsection{Wave propagation over a shoal: Berkhoff et al. (1982)  (in directory $/$berkhoff$\_$2d$/$)}

The laboratory experiment of wave propagation over a shoal conducted by Berkhoff et al. (1982) has served as a standard test for examining numerical model performances in predicting wave shoaling, refraction, diffraction and nonlinear dispersion. Kirby et al. (1998) showed that the previous version of FUNWAVE accurately reproduces measured wave heights in the experiments. Here, in this manual, we repeat this test exactly following Kirby et al. (1998).

The bottom topography is shown in Figure \ref{berkhoff_depth}, which  is generated using the same program in Kirby et al., (1998). The topography consists of an elliptic shoal resting on a plane beach with a constant slope 1/50. Bottom contours on the slope are oriented at an angle of 20$^\circ$ to the $y$ axis. Regular waves with period of  $1 s$ and amplitude of $2.32 cm$ are generated by a wavemaker at $x=-10m$ and propagate across the domain. Experiment data are collected along 8 transects as shown in the figure. Two vertical side walls are located at $y = -10 m$ and $y=10 m$. Detailed information on the geometry may be obtained in Berkhoff et al. (1982) or Kirby and Dalrymple (1984). 

The computational domain used in the model is the same as in Figure \ref{berkhoff_depth} except for two sponge layers with a width of $2 m$  sitting behind wavemaker and on the end of the beach. The source function for generating the corresponding monochromatic wave is located at the wavemaker. 

Thirty waves are simulated in order to  get a quasi-stable wave condition. The time series of surface elevation in the last 5 seconds (5 wave periods) are used for the wave height estimation at each grid point. Matlab post-processing scripts, {\em calcheight.m}  and {\em showheight.m} are provided in the example.  Figure \ref{berkhoff_section} shows comparisons between model results and experimental data along the eight transects where measurements were made. The model results of wave height agree well with experimental data, in both sections parallel or normal to incident wave direction. The results from the present model are also similar to that from the previous version of FUNWAVE in Kirby et al. (1998).

\begin{figure}[htbp]
\centering
\includegraphics[width=0.8\textwidth]{./figures/berkhoff_shoal.pdf}
\caption{Experiment layout for wave focusing experiment of Berkhoff et al. (1982).}
\label{berkhoff_depth}
\end{figure}

\begin{figure}[htbp]
\centering
\includegraphics[width=0.8\textwidth]{./figures/berkhoff_section.pdf}
\caption{Comparisons of wave height along specified sections between the model (solid lines) and experiment data (circles).}
\label{berkhoff_section}
\end{figure}

Parameters and other definitions specified in {\em input.txt} are listed below.

\vspace*{0.5cm}

  ! --------------------DEPTH------------------------------------- \\
DEPTH\_TYPE = DATA\\
DEPTH\_FILE = ../input/depth.txt\\

  ! ------------------DIMENSION-----------------------------\\
Mglob = 600\\
Nglob = 200\\

  ! ----------------- TIME----------------------------------\\
TOTAL\_TIME = 30.0\\
PLOT\_INTV = 0.02\\
PLOT\_INTV\_STATION = 0.02\\
SCREEN\_INTV = 0.1\\

  ! -----------------GRID----------------------------------\\
DX = 0.05\\
DY = 0.10\\

  ! ----------------WAVEMAKER------------------------------\\
WAVEMAKER = WK\_REG\\
Time\_ramp = 1.0 \\
Delta\_WK = 0.5    ! width parameter 0.3-0.6\\
DEP\_WK = 0.45\\
Xc\_WK = 3.0\\
Ywidth\_WK = 10000.0  ! give any larger value than the width of flume\\
Tperiod = 1.0\\
AMP\_WK = 0.0232\\
Theta\_WK = 0.0\\

  ! ---------------- SPONGE LAYER ------------------------\\
DIRECT \_SPONGE = T\\
Sponge\_west\_width =  2.0\\
Sponge\_east\_width =  2.0\\
Sponge\_south\_width = 0.0\\
Sponge\_north\_width = 0.0\\
R\_sponge = 0.90\\
A\_sponge = 5.0\\

  ! ----------------PHYSICS------------------------------\\
DISPERSION = T\\
Gamma1 = 1.0\\
Gamma2 = 1.0\\
Gamma3 = 1.0\\
Beta\_ref=-0.531\\
SWE\_ETA\_DEP = 0.80\\
Cd = 0.0\\

  ! ----------------NUMERICS----------------------------\\
Time\_Scheme = Runge\_Kutta\\
HIGH\_ORDER = FOURTH\\
CONSTRUCTION = HLLC\\
CFL = 0.5\\

  ! --------------WET-DRY-------------------------------\\
MinDepth=0.001\\
MinDepthFrc = 0.001\\

  ! -----------------OUTPUT-----------------------------\\
NumberStations = 0\\
DEPTH\_OUT = T\\
ETA = T\\


\subsection{Wave refraction-diffraction over a mound (Vincent and Briggs, 1989, provided by Choi and Seo)}

Vincent and Briggs (1989) performed experiments on monochromatic waves and frequency-direction spreading random waves which pass over a submerged elliptic shoal by using a directional spectral wave generator (DSWG) in Coastal and Hydraulics Laboratory's wave basin of the U.S. Army Engineer Research and Development Center. 

Figure \ref{vincent_briggs} demonstrates the computational domain based on the experiment layout of Vincent and Briggs (1989). Transect 4 represents one of the measurement transects where data are used to compare the model. FUNWAVE-TVD is set up for four cases, the non-breaking wave case, the breaking cases with the eddy-viscosity breaker and the shock-capturing breaker, and the irregular wave case. Here, we only present the non-breaking case and the breaking case with the eddy-viscosity breaker. The other cases can be found in the directories named by corresponding tests in the example package. 

The grid resolution for this case is $dx = dy = 0.05$ m, resulting in a model dimension of 760 x 500. The total computational time is 120.0 sec. The wavemaker is placed at $x = 10$ m.  Two sponge layers are used on both left and right sides with widths of 7.5 m and 5.0 m, respectively. 


 \begin{figure}[htbp]
\centering
\includegraphics[width=0.75\textwidth]{./figures/vincent_briggs_domain.jpg}
\caption{Computational domain for the case of Vincent and Briggs (1989).}
\label{vincent_briggs}
\end{figure}

\begin{figure}[htbp]
\centering
\includegraphics[width=0.75\textwidth]{./figures/vincent_briggs_nobrk.eps}
\caption{Comparison between data (circles) and model (solid line) in the non-breaking case of Vincent and Briggs (1989).}
\label{vincent_briggs_vis}
\end{figure}


\begin{figure}[htbp]
\centering
\includegraphics[width=0.75\textwidth]{./figures/vincent_briggs_vis.eps}
\caption{Comparison between data (circles) and model (solid line) in the breaking case of Vincent and Briggs (1989).}
\label{vincent_briggs_nonbrk}
\end{figure}

%The spectra for random wave generation were formed using TMA (Bouws et al., 1985) for the frequency spectrum and a wrapped normal distribution function for the directional spreading function (Borgman, 1984). 

Figure \ref{vincent_briggs_vis} and \ref{vincent_briggs_nonbrk} show model/data comparisons at Transect 4 for the non-breaking case and the breaking case, respectively.  Parameters and other definitions for the breaking wave case are specified in input.txt, listed below. 

  ! --------------------DEPTH------------------------------------- \\
DEPTH\_TYPE = DATA \\
DEPTH\_FILE = ../depth/dep\_ny501mx760.dat  \\

  ! ------------------DIMENSION----------------------------- \\
Mglob = 760 \\
Nglob = 501 \\

  ! ----------------- TIME---------------------------------- \\
  TOTAL\_TIME = 120.0 \\
PLOT\_INTV = 0.05 \\

  ! -----------------GRID----------------------------------  \\
  DX = 0.05  \\
DY = 0.05  \\

  ! ----------------WAVEMAKER------------------------------  \\
  WAVEMAKER = WK\_REG \\
  Delta\_WK = 2.0   !(large number to avoid breaking inside wavemaker) \\
  Xc\_WK = 10.0 \\
Yc\_WK = 12.5 \\
Ywidth\_WK = 20000.0 \\
Tperiod = 1.3  \\
AMP\_WK = 0.0675 \\
Theta\_WK = 0.0 \\

  ! ---------------- SPONGE LAYER ------------------------ \\
  FRICTION\_SPONGE = T \\
DIRECT\_SPONGE = T \\
CDsponge = 1.0 \\
Sponge\_west\_width =  7.5 \\
Sponge\_east\_width =  5.0 \\
R\_sponge = 0.85 \\
A\_sponge = 5.0 \\

! ----------------PHYSICS------------------------------ \\
DISPERSION = T \\
Gamma1 = 1.0 \\
Gamma2 = 1.0  \\
Gamma3 = 1.0  \\
Beta\_ref=-0.531 \\
VISCOSITY\_BREAKING = T \\

!----------------Friction-----------------------------  \\
Friction\_Matrix=F  \\
Cd = 0.0 \\

! ----------------NUMERICS---------------------------- \\
Time\_Scheme = Runge\_Kutta \\
HIGH\_ORDER = FOURTH \\
CFL = 0.2 \\

! -----------------OUTPUT----------------------------- \\
NumberStations = 0  \\
ETA = T  \\

Cases for Vincent and Briggs' experiments are included in the directory /vincent\_briggs in the example package. The sub-directories are

/01\_eddy\_breaking : breaking case with eddy-viscosity breaker \\
/02\_shock\_breaking: breaking case with shock-capturing breaker \\
/03\_nonbreaking: non-breaking case \\
/04\_irregular: irregular wave case \\
/depth: depth files \\
/postprocessing: matlab scripts for post-processing \\

In addition, a readme file, README.txt, is included in the directory to describe how to post-process results and plot figures. 


\subsection{Periodic wave over submerged bar (Luth et al., 1994, provided by Choi and Seo)}

It is well known that regular waves decompose into higher frequency free waves as they propagate past a submerged bar, as shown in experimental work by Beji and Battjes (1993), Luth et al. (1994), and Ohyama et al. (1994). Comparisons between several weakly nonlinear Boussinesq-type models and experimental data by Beji and Battjes (1993) and Luth et al. (1994) of waves propagating over a submerged bar were presented by Dingemans (1994).  

The experiments performed by Beji and Battjes (1993) and Luth et al. (1994) have the same geometric characteristics, except for the length scale (Luth et al., 1994 is twice as large as in Beji and Battjes, 1993). In Luth et al. (1994) all gauge locations used in Beji and Battjes (1993) were repeated, and another run of measurements was performed with the gauges at different locations.
In this section, we compare the present model with two laboratory experimental data sets, Case A and C,  by Luth et al. (1994).  

The layout of the experimental set-up with the locations of the measurement stations (to which we refer by their location, e.g., gauge 2.0 m, gauge 15.7 m, etc.) and the geometry of the flume are illustrated in Figure \ref{luth_layout}.

 \begin{figure}[htbp]
\centering
\includegraphics[width=0.9\textwidth]{./figures/luth_layout.jpg}
\caption{Sketch of wave flume of Delft experiments. All dimensions in (m).}
\label{luth_layout}
\end{figure}

The model is set up in a 54 m long flume based on the experiment layout but extended on both sides in order to include sponge layers. The wavemaker is specified at $x$ = 10.0 m and wave gauges are located at $x$ = 20.0 m + (2.0 m, 4.0 m, ..., 23.0 m), respectively. The grid size $dx = dy = 0.02$ m. 

Figure \ref{luth_A}  and \ref{luth_C} show model/data comparisons of Case A and Case C, respectively. Parameters and other definitions specified for Case A are listed below. 

   ! --------------------DEPTH------------------------------------- \\
   DEPTH\_TYPE = DATA \\
   DEPTH\_FILE = ../depth/dep\_ny6mx2700.dat \\
   
     ! ------------------DIMENSION----------------------------- \\
 Mglob = 2700 \\
Nglob = 3 \\

! -----------------GRID---------------------------------- \\
DX = 0.02 \\
DY = 0.02 \\

  ! ----------------WAVEMAKER------------------------------ \\
  WAVEMAKER = WK\_REG \\
  DEP\_WK = 0.4 \\
Xc\_WK = 10.0 \\
Yc\_WK = 0.0 \\
Ywidth\_WK = 20000.0  (any number larger than the flume width) \\
 Tperiod = 2.02 \\
AMP\_WK = 0.01 \\
Theta\_WK = 0.0   \\

  ! ---------------- SPONGE LAYER ------------------------ \\
 FRICTION\_SPONGE = T \\
DIRECT\_SPONGE = T     \\
CDsponge = 1.0 \\
Sponge\_west\_width =  8.0 \\
Sponge\_east\_width =  8.0  \\
Sponge\_south\_width = 0.0  \\
Sponge\_north\_width = 0.0  \\
R\_sponge = 0.85  \\
A\_sponge = 5.0  \\

  ! ----------------PHYSICS------------------------------ \\
  DISPERSION = T \\
Gamma1 = 1.0 \\
Gamma2 = 1.0 \\
Gamma3 = 1.0 \\


 !----------------Friction----------------------------- \\
 Friction\_Matrix=F \\
Cd = 0.0  \\

 ! ----------------NUMERICS---------------------------- \\
HIGH\_ORDER = FOURTH
CFL = 0.2 \\

! -----------------OUTPUT----------------------------- \\
NumberStations = 10 \\
STATIONS\_FILE = gauges.txt \\
ETA = T \\



The case is included in the example package directory /car\_luth\_AC/.  Model setups for a finer grid resolution ($dx = 0.01m$ are also provided in the example package:

/01\_CaseA : Case A with $dx = 0.02$ m

/01\_CaseA\_finer: Case A with $dx = 0.01$ m

/01\_CaseC : Case C with $dx = 0.02$ m

/01\_CaseC\_finer: Case C with $dx = 0.01$ m

/depth:  depth files

/lab\_data: lab data

/postprocessing: matlab scrips to plot model/data comparisons such as plot\_compare\_A.m, plot\_compare\_C.m, plot\_compare\_A\_finer.m and plot\_compare\_C\_finer.m

 \begin{figure}[htbp]
\centering
\includegraphics[width=0.9\textwidth]{./figures/luth_A.jpg}
\caption{Comparison of model (solid lines) and data (circles) at measurement gauges (Note that the reference of $x$ shifts 20m vs. experiment). Luth et al. Case A.}
\label{luth_A}
\end{figure}

 \begin{figure}[htbp]
\centering
\includegraphics[width=0.9\textwidth]{./figures/luth_C.jpg}
\caption{Comparison of model (solid lines) and data (circles) at measurement gauges (Note that the reference of $x$ shifts 20m vs. experiment). Luth et al. Case C.}
\label{luth_C}
\end{figure}

\subsection{Solitary wave on a conical island}

Laboratory experiments on the interaction between solitary waves and a conical island were conducted by Briggs et al (1995).  The three cases from this test illustrate the important fact that runup and inundation heights on the sheltered back sides of an island can exceed the incident wave height on the exposed front side, due to trapping of wave fronts propagating around the island circumference.  These tests have been used in a number of validation studies for a variety of models, including nonlinear shallow water equations (Liu et al 1995) and Boussinesq equations (Chen et al, 2000).   The benchmark test is specified in Section 3.3 of Appendix A of Synolakis et al (2007).

Large-scale laboratory experiments were performed at Coastal Engineering Research Center, Vicksburg, Mississippi, in a 30m-wide, 25m-long, and 60cm-deep wave basin (Figure {\ref{figure4.3.1}}).  In the physical model, a 62.5cm-high, 7.2m toe-diameter, and 2.2m crest-diameter circular island with a 1:4 slope was located in the basin (Figure  {\ref{figure4.3.2}}). Experiments were conducted at depth of 32cm, with three different solitary waves (H/d=0.045, 0.091, 0.181). Water-surface time histories were measured with 27 wave gages located around the perimeter of the island (Figure {\ref{figure4.3.3}}).

\begin{figure}[htbp]
\centering
\includegraphics[width=0.7\textwidth]{./figures/caseA.pdf}
\caption{View of conical island(top) and basin(bottom)(from Synolakis et al (2007, Figure A16)).}
\label{figure4.3.1}
\end{figure}

\begin{figure}[htbp]
\centering
\includegraphics[width=0.7\textwidth]{./figures//caseB.pdf}
\caption{Definition sketch for conical island. All dimensions are in cm (from Synolakis et al (2007, Figure A17)).}
\label{figure4.3.2}
\end{figure}

\begin{figure}[htbp]
\centering
\includegraphics[width=0.7\textwidth]{./figures/caseC.pdf}
\caption{Schematic gauge locations around the conical island(from Synolakis et al (2007, Figure A18)).}
\label{figure4.3.3}
\end{figure}

For this benchmark test, time histories of the surface elevation around the circular island are given at four locations, i.e., in the front of the island at the toe (Gauge 6) and gauges closest to the shoreline with the numbers 9, 16, and 22 located at the $0^\circ$, $90^\circ$, and $180^\circ$ radial lines (Figure {\ref{figure4.3.3}}). A grid size of $\Delta x=0.05m$ is considered for proper numerical simulation of this benchmark. Figures {\ref{figure4.3.4}}-{\ref{figure4.3.6}} shows the comparison between the laboratory data with numerical calculations. Table {\ref{table6}} represents the error of the maximum runup for each gauge for different wave heights.

\begin{figure}[t]
\centering
\includegraphics[width=0.7\textwidth]{./figures/figure4_3_4.pdf}
\caption{Comparison of computed and measured time series of free surface for $H/d=0.045$.Solid lines: measured, Dashed lines: Computed.}
\label{figure4.3.4}
\end{figure}

\begin{figure}[htbp]
\centering
\includegraphics[width=0.7\textwidth]{./figures/figure4_3_5.pdf}
\caption{Comparison of computed and measured time series of free surface for $H/d=0.091$.Solid lines: measured, Dashed lines: Computed.}
\label{figure4.3.5}
\end{figure}

\begin{figure}[htbp]
\centering
\includegraphics[width=0.7\textwidth]{./figures/figure4_3_6.pdf}
\caption{Comparison of computed and measured time series of free surface for $H/d=0.181$.Solid lines: measured, Dashed lines: Computed.}
\label{figure4.3.6}
\end{figure}

\begin{table}[t]
\centering
\begin{tabular}{l l l l l}
                &   \multicolumn{4}{c}{Gauge Number } \\ \cline{2-5}
      $H/d$ &   6  &  9  &  16  &  22  \\ \hline
      0.045 &  6.0  &  13.2  &  0.1  &  18.9  \\
      0.091 &  3.2  &  16.6  & 11.6  &  0.26  \\
      0.181 &  1.6  &  13.33  &  13.8  &  13.3 \\
\end{tabular}
\caption{Percent error of predicted maximum runup calculated for each gauge in conical island test.}
\label{table6}
\end{table}

Input parameters in the tests are listed as below.

\vspace*{0.5cm}

  ! --------------------DEPTH------------------------------------- \\
DEPTH\_TYPE = DATA\\
DEPTH\_FILE = ../input/depth.txt\\

  ! ------------------DIMENSION-----------------------------\\
Mglob = 702\\
Nglob = 602\\

  ! ----------------- TIME----------------------------------\\
TOTAL\_TIME = 25.0\\
PLOT\_INTV = 1.0\\
PLOT\_INTV\_STATION = 0.05\\
SCREEN\_INTV = 1.0\\

  ! -----------------GRID----------------------------------\\
DX = 0.05\\
DY = 0.05\\

  ! ----------------WAVEMAKER------------------------------\\
WAVEMAKER = INI\_SOL\\
AMP = 0.0144    !  0.02912 for case B and 0.05792 for case C\\
DEP = 0.32  \\
LAGTIME = 5.0\\
XWAVEMAKER = 8.0\\

  ! ---------------- SPONGE LAYER ------------------------\\
DIRECT \_SPONGE = F\\
FRICTION\_SPONGE = F \\
DIFFUSION\_SPONGE = F \\

  ! ----------------PHYSICS------------------------------\\
DISPERSION = T\\
Gamma1 = 1.0\\
Gamma2 = 1.0\\
Gamma3 = 1.0\\
Beta\_ref=-0.531\\
SWE\_ETA\_DEP = 0.80\\
Cd = 0.01    ! note: not sensitive, could give a small value like 0.001\\

  ! ----------------NUMERICS----------------------------\\
Time\_Scheme = Runge\_Kutta\\
HIGH\_ORDER = FOURTH\\
CONSTRUCTION = HLLC\\
CFL = 0.5\\

  ! --------------WET-DRY-------------------------------\\
MinDepth=0.001\\
MinDepthFrc = 0.001\\

  ! -----------------OUTPUT-----------------------------\\
NumberStations = 16\\
STATIONS\_FILE = gauges.txt\\
DEPTH\_OUT = T\\
ETA = T\\
Hmax = T\\
MASK = T\\

The results of surface elevation at seven gauges are saved as sta\_0001 ... sta\_0016 as specified in input.txt. Model/data comparisons are carried out at sta\_0001 (gauge 6),  sta\_0002 (gauge 9),  sta\_0008 (gauge16),  sta\_0022 (gauge 22).
A post-processing MATLAB script called {\em plot\_comparison.m}  can be used for model/data comparisons.   

\subsection{Solitary wave runup on a shelf with an island  (in directory $/$solitary$\_$runup$\_$2d)}

In this test, we performed a simulation of the solitary wave runup measured  recently in a large wave basin at Oregon State University's O.H. Hinsdale Wave Research Laboratory.  The basin is 48.8 m long, 26.5 m wide, and 2.1 m deep.  A complex bathymetry has been constructed, which  consists of  a 1:30 slope planar beach connected to a triangle shaped  shelf and a conical island on the shelf as shown  in Figure \ref{fig8}.    Solitary waves were generated on the left side by a piston-type wavemaker. Surface elevation and velocity were collected at many locations by wave gauges and ADV's in alongshore and cross-shore arrays (See Swigler and Lynett, 2011 for details). Figure \ref{fig8} shows  wave gauges (circles)  and  ADV's (triangles) used for model/data comparisons in the present study. Gauge 1 - 9 were located at $(x,y) = $ (7.5, 0.0), (13.0, 0.0), (21.0 0.0), (7.5 5.0), (13.0 5.0), (21.0 5.0), (25.0 0.0), (25.0 5.0) and (25.0, 10.0), respectively. ADV 1 -  3 were located at (13.0 0.0), (21.0, 0.0) and (21.0, -5.0), respectively.   



\begin{figure}[htbp]
\centering
\includegraphics[width=0.8\textwidth]{./figures/bm2depth.pdf}
\caption{Bathymetry contours (in meters) and measurement locations used in model/data comparisons. Circles: pressure gauges, triangles: ADV.}
\label{fig8}
\end{figure}


\begin{figure}[htbp]
\centering
\includegraphics[width=0.55\textwidth]{./figures/snap_16x02.pdf} \\
\includegraphics[width=0.55\textwidth]{./figures/snap_26x02.pdf} \\
\includegraphics[width=0.55\textwidth]{./figures/snap_56x02.pdf}			
\caption{Modeled water surface at (top)  $t$ = 6.4 s, (middle) $ t$ =8.4 s, (bottom) $ t$ =14.4 s.}
\label{snap1}
\end{figure}

%\begin{figure}[htbp]
%\centering
%\includegraphics[width=0.6\textwidth]{./figures/dt.pdf}
%\caption{Time step variation.}
%\label{dt}
%\end{figure}

\begin{figure}[htbp]
\centering
\includegraphics[width=1.0\textwidth]{./figures/figure11.pdf}	
\caption{Model/data comparisons of time series of surface elevation at (top) Gauge 1 -  Gauge 9. Solid line: model,  stars: data.}
\label{gauge1}
\end{figure}

\begin{figure}[htbp]
\centering
\includegraphics[width=0.8\textwidth]{./figures/figure12.pdf}
\caption{Model/data comparisons of time series of velocity $u$ component at ADV 1  (top panel),  ADV 2 (second panel),  ADV 3 (third panel), and $v$ component at ADV 3 (bottom panel). Solid line: model,  dashed line: data.}
\label{adv1}
\end{figure}


The modeled bathymetry  was constructed by combining the measured data of the shelf and the analytical equation of the cone, which was used for the design of the island in the experiment.   The computational domain was modified by extending the domain from $x$ = 0.0 m to -5.0 m with a constant water depth of 0.78 m in order to use a solitary wave solution as an initial condition. The width of the computational domain in the $y$ direction is the same as OSU's  basin. Grid spacing used in the model is 0.1 m in both directions. A solitary wave solution based on Nwogu's extended Boussinesq equations  was used with  centroid located at $x$ = 5.0  The wave height is 0.39 m as  that used in the laboratory experiment.
 
Figure \ref{snap1} shows results of computed  water surfaces at $t $= 6.4  s, 8.4  s and 14.4 s, respectively. The  wave front becomes very steep as the wave climbs on the shelf, which was well captured by the model. The wave scattering pattern is clearly seen in the bottom panel of Figure \ref{snap1}. Wave breaking on the shelf was observed in the laboratory experiment and was also seen in the  model.  
%Figure \ref{dt} shows the variation in time stepping during the simulation.   The time step dropped to a minimum, at  around $t$ = 6.5 s,   as the wave collided with the island (top panel of figure \ref{snap1}). The local Froude number reached a maximum at $t$ = 6.5 s, reducing the value of the time step based on (\ref{cfl}).

Figure \ref{gauge1} shows  time series of modeled surface elevations and measurements at Gauge 1 - 9  (from top to bottom). 
Good agreement between model and data is  found at the gauge in front of the island (Gauge 1, top panel), as the model successfully predicts the solitary wave propagation and its reflection from the shore.   The model also captures the collision of edge waves propagating around the two sides of the island,  as indicated at the gauge behind the island (Gauge 3). The model  predicts the timing of wave collision well but over-predicts the peak of wave runup.  The model/data comparisons at Gauges 5, 6, 8, and 9, which are located at the north-side shelf, indicates that the model predicts wave refraction and breaking on the shelf  reasonably well.   

Figure   \ref{adv1} shows model/data comparisons of  velocity time series   of velocity $u$ component at ADV 1 (top panel), ADV 2 (second panel), ADV 3 (third panel), and $v$ component at ADV 3 (bottom panel). 
The model predicts the peak velocity and the entire trend of velocity variation in time at both locations. An underprediction of the seaward velocity is found at ADV 2. The velocity in the $y$-direction was not compared at ADV 1 and ADV2 because the measured values were too small.  

The input parameters for this test are listed below.


\vspace*{0.5cm}
  ! --------------------DEPTH-------------------------------------\\
  DEPTH\_TYPE = DATA\\
DEPTH\_FILE = ../input/depth\_wkshop.txt\\

  ! ------------------DIMENSION-----------------------------\\
Mglob = 501\\
Nglob = 261\\

  ! ----------------- TIME----------------------------------\\
TOTAL\_TIME = 45.0\\
PLOT\_INTV = 0.2\\
PLOT\_INTV\_STATION = 0.2\\
SCREEN\_INTV = 0.2  \\

  ! -----------------GRID----------------------------------\\
DX = 0.1\\
DY = 0.1\\
  
   ! ----------------WAVEMAKER------------------------------\\
WAVEMAKER = INI\_SOL\\
AMP = 0.39\\
DEP = 0.78\\
LAGTIME = 5.0\\
XWAVEMAKER = 10.0  ! note that means x = 5 m because the domain starts at x = -5\\

  ! ---------------- SPONGE LAYER ------------------------\\
DIRECT \_SPONGE = F\\
FRICTION\_SPONGE = F \\
DIFFUSION\_SPONGE = F \\

  ! ----------------PHYSICS------------------------------\\
DISPERSION = T\\
Gamma1 = 1.0\\
Gamma2 = 1.0\\
Gamma3 = 1.0\\
Beta\_ref=-0.531\\
SWE\_ETA\_DEP = 0.80\\
Cd = 0.001\\
 
  ! ----------------NUMERICS----------------------------\\
Time\_Scheme = Runge\_Kutta\\
HIGH\_ORDER = FOURTH\\
CONSTRUCTION = HLLC\\
CFL = 0.5\\

  ! --------------WET-DRY-------------------------------\\
MinDepth=0.001\\
MinDepthFrc = 0.001\\

  ! -----------------OUTPUT-----------------------------\\
DEPTH\_OUT = T\\
U = T\\
V = T\\
ETA = T\\
MASK = T\\

Several post-processing procedures are performed in order to get model/data comparisons. First, {\em read\_result.m} is used to obtained time series of $\eta$ at 9 pressure gauges , and $u$ and $v$ at 3 ADV locations. Then, {\em plot\_WG.m} is used for comparisons of  surface elevation at the 9 gauges,  {\em plot\_ADV\_AB.m} for 
comparisons of $u$ at ADV 1 and 2, and {\em plot\_ADV\_C.m} for $u$ and $v$ at ADV 3. 


\subsection{Nesting case}


We provide a 1-D example indicating that a solitary wave of permanent form is undistorted as it moves from a large domain
Grid\_A to a smaller scale grid Grid\_B.  In Grid\_A, the computational domain is 6000m long with  10 m constant water depth. Grid size is 4 m. An initial solitary wave with an amplitude of 1m is centered at  x=1000.0 m. Grid\_B,  with a grid size of dx=2m , is nested inside Grid\_A. The nesting boundary is at x=2000.0m in Grid\_A. The calculation of Grid\_A provides a time series of $u,v$ and $\eta$ through output at gauges at x=2000.0m 
($i=500$, where $i$ is grid number in x direction in Grid\_A).  The spherical mode is used a demonstration of the nesting case.

There are three sub-directories for the nesting example. 

\vspace{0.2cm}
\noindent
{\bf directory:}  /examples/sph\_nesting / \\

/grid\_A/ contains input file, executive and station file for Grid\_A run.

/make\_nest\_file/ contains a Fortran code to generate the nesting input based on output from Grid\_A.

/grid\_B/ contains input file and executive file for Grid\_B calculation.

\vspace{0.2cm}
\noindent
{\bf procedure: } 

1) run model Grid\_A. {\bf NOTE:} the executive file should be compiled with '-DCOUPLING' turned OFF (Makefile in /src/).

2) generate nesting input file using convert.f in /make\_nest\_file/.

3)run model Grid\_B.   {\bf NOTE:} the executive file should be compiled with '-DCOUPLING' turned ON (Makefile in /src/).

\vspace{0.2cm}
\noindent
{\bf postprocessing: } use plot\_ab.m to plot results. Figure \ref{nesting} shows results from Grid\_A (upper pannl) and Grid\_B (lower panel).


The input parameters for Grid\_A are listed below.

\vspace*{0.5cm}
  ! --------------------DEPTH------------------------------------- \\
DEPTH\_TYPE = FLAT\\
DEPTH\_FLAT = 10.0\\

  ! ----------------- TIME----------------------------------\\
TOTAL\_TIME = 400.0\\
PLOT\_INTV = 1.0\\
PLOT\_INTV\_STATION = 0.0 !  0.0 means make station output every time step for nesting data \\
SCREEN\_INTV = 1.0\\\

  ! -----------------GRID----------------------------------\\
  StretchGrid = F\\
Lon\_West = 120.0\\
Lat\_South = 0.0\\
Dphi = 0.000035972\\
Dtheta = 0.0001 \\

  ! ----------------WAVEMAKER------------------------------\\
 WAVEMAKER = INI\_SOL\\
  AMP = 0.1\\
DEP = 10.0\\
LAGTIME = 0.0\\
XWAVEMAKER = 1000.0\\


! ----------------PHYSICS------------------------------\\
DISPERSION = T\\
Gamma1 = 1.0\\
Gamma2 = 0.0\\
Gamma3 = 1.0\\
Beta\_ref=-0.531\\
SWE\_ETA\_DEP = 0.80\\
Cd = 0.00\\

  ! ----------------NUMERICS----------------------------\\
  Time\_Scheme = Runge\_Kutta\\
HIGH\_ORDER = THIRD\\
CONSTRUCTION = HLLC\\
CFL = 0.5\\
FroudeCap = 10.0\\

  ! -----------------OUTPUT-----------------------------\\
  NumberStations = 3\\
  STATIONS\_FILE = station.txt\\
  

The input parameters for Grid\_B are listed below.

\vspace*{0.5cm}
  ! --------------------DEPTH------------------------------------- \\
DEPTH\_TYPE = FLAT\\
DEPTH\_FLAT = 10.0\\

  ! ----------------- TIME----------------------------------\\
TOTAL\_TIME = 400.0\\
PLOT\_INTV = 1.0\\
PLOT\_INTV\_STATION = 1.00\\
SCREEN\_INTV = 1.0\\\

  ! -----------------GRID----------------------------------\\
  StretchGrid = F\\
Lon\_West = 120.0\\
Lat\_South = 0.0\\
Dphi = 0.000017986\\
Dtheta = 0.0001 \\

  ! ----------------WAVEMAKER------------------------------\\
 WAVEMAKER = INI\_SOL\\
  AMP = 0.1\\
DEP = 10.0\\
LAGTIME = 0.0\\
XWAVEMAKER = 1000.0\\


! ----------------PHYSICS------------------------------\\
DISPERSION = T\\
Gamma1 = 1.0\\
Gamma2 = 0.0\\
Gamma3 = 1.0\\
Beta\_ref=-0.531\\
SWE\_ETA\_DEP = 0.80\\
Cd = 0.00\\

  ! ----------------NUMERICS----------------------------\\
  Time\_Scheme = Runge\_Kutta\\
HIGH\_ORDER = THIRD\\
CONSTRUCTION = HLLC\\
CFL = 0.5\\
FroudeCap = 10.0\\

  ! ----------------- COUPLING -------------------------\\
  COUPLING\_FILE = ../make\_nest\_file/coupling.txt

\begin{figure}[htbp]
\centering
\includegraphics[width=1.0\textwidth]{./figures/solitary_nesting_v20.pdf}
\caption{Solitary wave calculated in a larger domain Grid\_A (upper) and in a nested smaller domain Grid\_B (lower) at t=100s, 200s, 300s, and 400s.}
\label{nesting}
\end{figure}


\section{Dealing with numerical instability}

One of the goals of the new code development is to improve numerical stability for large-scale and long time simulations. It has been indicated, by both our own tests and users' feedback, that the numerical stability of the TVD version of FUNWAVE has been greatly improved in contrast to the previous version. No more filtering is required in FUNWAVE-TVD. However, numerical instability is a general property of numerical algorithms, especially as a higher-order numerical scheme is applied. Here, we would like to share our experiences in dealing with
numerical instabilities.

\begin{enumerate}

\item Avoid large bathymetric slope. 

A rapidly varying bathymetry may cause numerical noises due to a large $\nabla h$ in the source term. Although the surface gradient term is in a well-balanced form as described in the theory section, an unreasonably large bottom slope may  cause numerical instability. Based on our experiences, $|\nabla h| > 1.0$ should be avoided. 

\item Use FroudeCap to limit a huge velocity occurring in extremely shallow water

The model uses a Froude number cap to avoid an unrealistic flow velocity in extremely shallow water specified as $MinDepthFrc$ by a user.  The unrealistic velocity usually occurs at a wetting-drying interface. The default value for FroudeCap is 10.0. Using a smaller value such as FroudeCap = 3.0 or smaller can avoid the problem and also improve the model efficiency in terms of the CFL algorithm. 
 Note: a FroudeCap smaller than 1.5 is not suggested because it may cap velocities at flooding water fronts. 

\item  Adjust MinDepthFrc

The default value of the wetting-drying threshold, MinDepthFrc,  is 0.001 m. Using a small value may cause a large velocity at a wetting-drying point, resulting in a small $dt$. It may also cause numerical instability. Use a larger value when a problem occurs. 

\item Use a smaller Courant number

The default value of CFL is 0.5. A smaller value can be used if instability occurs. 

\item Use a lower-order spatial scheme

The MUSCL-TVD schemes up to fourth-order are implemented in the code. Initially we used the scheme introduced by Yamamoto et al. (1998) who applied the Minmod limiter in the fourth-order scheme. Abadie et al. (2012) pointed out that the fourth-order scheme  has an instability problem for simulations in deep water. For this reason, the third-order scheme is suggested if an instability problem occurs. 

In Version 3.0, we implemented the fourth-order scheme of Erduran et al. (2005) who 
used the van-Leer limiter for the third-order part of the fourth-order scheme. We hope that this scheme can improve the model stability. 

\end{enumerate}

\section{References}

\begin{description}

\item Agnon, Y., Madsen, P. A. and Sch\"{a}ffer, H. A., 1999, ``A new approach to high-order Boussinesq models'', {\em J. Fluid Mech.}, {\bf 399}, 319-333.

\item Berkhoff, J. C. W., Booy, N. and Radder, A. C., 1982, ``Verification of numerical wave propagation models for simple harmonic linear water waves", {\em Coast. Engrg.}, {\bf 6}, 255-279.

\item Berm\`{u}dez, A. and  V\`{a}zquez, M. E., 1994, ``Upwind methods for hyperbolic conservation laws with source terms", {\em Comput. Fluids}, {\bf 23} (8), 1049-1071.

\item Briggs, M. J., Synolakis, C. E., and Harkins, G. S., 1994,  ``Tsunami run- up on a conical island",  {\em Proc., Waves-Physical and Numerical Modelling}, International Association for Hydraulic Research, Delft, The Netherlands, 446-455.

\item Brown, J., MacMahan, J.,   Reniers, A. J. H. M. and Thornton, E., 2009, ``Surf zone diffusivity on a rip-channeled beach'', {\em J. Geophys. Res.}, {\bf 114}, C11015, doi:10.1029/2008JC005158.

\item Chen, Q., Dalrymple, R. A.,   Kirby, J. T.,  Kennedy, A. B.  and  Haller, M. C., 1999, ``Boussinesq modelling of a rip current system",  {em J. Geophys. Res.}, {\bf 104}, 20,617-20,637.

\item Chen, Q., Kirby, J. T., Dalrymple, R. A., Kennedy, A. B. and Chawla, A., 2000, ``Boussinesq modeling of wave transformation, breaking and runup.  II: 2D'', {\em J. Waterway, Port, Coastal and Ocean Engineering}, {\bf 126}, 48-56.

\item Chen, Q., Kirby, J. T., Dalrymple, R. A., Shi, F. and Thornton, E. B., 2003, ``Boussinesq modeling of longshore currents", {\em Journal of Geophysical Research}, {\bf 108}(C11), 3362, doi:10.1029/2002JC001308.

\item Chen, Q., Kaihatu, J. M., and Hwang, P. A., 2004, ``Incorporation of Wind Effects Into Boussinesq Wave Models", {\em J. Waterway, Port, Coastal and Ocean Engineering}, {\bf 130}, 312-321.

\item Chen, Q., 2006, ``Fully nonlinear Boussinesq-type equations for waves and currents over porous beds", {\em  Journal of Engineering Mechanics.} {\bf 132} (2): 220-230.

\item Erduran, K. S., Ilic, S., and Kutija, V., 2005, ``Hybrid finite-volume finite-difference scheme for the solution of Boussinesq equations", {\em Int. J. Numer. Meth. Fluid.}, {\bf 49}, 1213-1232.

\item Gobbi, M. F., Kirby, J. T. and Wei, G., 2000,  ``A fully nonlinear Boussinesq model for surface waves. II. Extension to $O(kh^4)$", {\em Journal of Fluid Mechanics},  {\bf 405}, pp. 181-210.

\item Goda, Y., 2000, Random seas and design of maritime structures, {\em Advanced Series on Ocean Engineering}, Volume 15, 2nd Edition, World Scientific, Singapore. 

\item Gottlieb, S., Shu C.-W., and Tadmore, E., 2001, ``Strong stability-preserving high-order time discretization methods", {\em SIAM Review}, {\bf 43} (1), 89 - 112.

\item Hansen, J. B., and Svendsen, I. A., 1979,  ``Regular waves in shoaling water: Experimental data",  Tech. Rep. ISVA Ser., 21, Technical Univ. of Denmark, Denmark.

\item Kennedy, A. B., Chen, Q., Kirby, J. T. and Dalrymple, R. A., 2000, ``Boussinesq modeling of wave transformation, breaking and runup. I: 1D'', {\em J. Waterway, Port, Coastal and Ocean Engineering}, {\bf 126}, 39-47.

\item Kennedy, A. B., Kirby, J. T., Chen, Q. and Dalrymple, R. A., 2001,  ``Boussinesq-type equations with improved nonlinear performance", {\em Wave Motion},  {\bf 33}, pp. 225-243.

\item Kim D. H., Cho, Y. S., and Kim, H. J., 2008, ``Well-balanced scheme between flux and source terms for computation of shallow-water equations over irregular bathymetry", {\em Journal of Engineering Mechanics}, {\bf 134}, 277-290.

\item Kim, D. H., Lynett, P. J. and Socolofsky, S. A., 2009, ``A depth-integrated model for weakly dispersive, turbulent, and rotational
fluid flows'', {\em Ocean Modeling}, {\bf 27}, 198-214.

\item Kim, D. H., 2009, ``Turbulent flow and transport modeling by long waves and currents'', Ph.D. dissertation, Texas A\& M University.

\item Kirby, J. T., Wei, G., Chen, Q., Kennedy, A. B. and Dalrymple, R. A., 1998,  ``FUNWAVE 1.0, Fully nonlinear Boussinesq wave model. Documentation and users manual". Report CACR-98-06, Center for Applied Coastal Research, Department of Civil and Environmental Engineering, University of Delaware.

\item Kirby, J.T., Shi, F., Watts, P., Grilli, S.T., 2004,  ``Propagation of short, dispersive tsunami waves in ocean basins". EOS Transactions of the AGU 85 (47) Abstract OS21E-02.

\item Kirby, J. T., Shi, F., Harris, J. C., and Grilli, S. T., 2012, ``Sensitivity analysis of trans-oceanic tsunami propagation to dispersive and Coriolis effects", {\em Ocean Modelling}, under revision.  

\item Liang, Q. and Marche, F., 2009, ``Numerical resolution of well-balanced shallow water equations with complex source terms", {\em Advances in Water Resources}, {\bf 32}, 873 - 884.

\item Long, W. and Kirby, J. T., 2006,  ``Boussinesq modeling of waves, currents and sediment transport", Research Report No. CACR-06-02, Center for Applied Coastal Research, Dept. of Civil and Environmental Engineering, Univ. of Delaware, Newark. 

\item Lynett, P. J., Wu, T.-R. and Liu, P. L.-F., 2002,  ``Modeling wave runup with depth-integrated equations",  {\em Coastal Engineering},  
{\bf 46}, 89-107.

\item Madsen, P.A., Srensen, O.R., 1992,  ``A new form of the Boussinesq equations with improved linear dispersion characteristics. Part 2. A slowly-varying bathymetry",  {\em Coastal Engineering}  {\bf 18} (3-4), 183-204.


\item Mase, H., and Kirby, J. T., 1992,   ``Hybrid frequency-domain KdV equation for random wave transformation", {\em Proc., 23rd Int. Conf. Coast. Eng.}, ASCE, New York, 474-487.

\item Naik, N. H., Naik, V. K., and Nicoules, M., 1993, ``Parallelization of a class of implicit finite difference schemes in computational fluid dynamics", {\em  International Journal of High Speed Computing},  {\bf 5}: 1-50.


\item Ning, D. Z., Zang, J., Liang, Q., Taylor, P. H., and Borthwick, A. G. L., 2008, ``Boussinesq cut-cell model for non-linear wave interaction with coastal structures", {\em International Journal for Numerical Methods in Fluids}, {\bf 57} (10), 1459-1483.

\item Nwogu, O., 1993, ``An alternative form of the Boussinesq equations for nearshore wave propagation", {\em Journal of Waterway, Port, Coastal, and Ocean Engineering}, {\bf 119} (6), pp. 618-638. 

\item Nwogu, O. and Demirbilek, Z., 2001, ``BOUSS-2D: A Boussinesq wave model for coastal regions and harbors",  ERDC/CHL TR-01-25, Coastal and Hydraulics Laboratory, USACOE Engineer Research and Development Center,  Vicksburg, MS.

\item Roeber, V., Cheung, K. F., and Kobayashi, M. H., 2010, ``Shock-capturing Boussinesq-type model for nearshore wave processes", {\em Coastal Engineering}, {\bf 57}, 407-423.

\item Rogers, B. D., Borthwick, A. G. L., and Taylor, P. H., 2003, ``Mathematical balancing of flux gradient and source terms prior to using Roe's approximate Riemann solver", {\em Journal of Computational Physics}, {\bf 192}, 422-451.


\item Shi, F., Kirby, J. T., Harris, J. C., Geiman, J. D., and Grilli, S. T., 2012 a, ``A high-order adaptive time-stepping TVD solver for Boussinesq modeling of breaking waves and coastal inundation", {\em Ocean Modelling}, 43-44, 36-51.


\item Shi, F., Kirby, J. T., and Tehranirad, B. , 2012 b, Tsunami benchmark results for
spherical coordinate, Center for Applied Coastal Research Report, CACR 2012-02, University of Delaware, Newark, Delaware. 

\item Shi, F., Kirby, J. T., Tehranirad, B. and Harris, J. C., 2011, FUNWAVE-TVD, Version 1.0, users' manual and benchmark tests, Center for Applied Coastal Research Report, CACR 2011-04, University of Delaware, Newark, Delaware. 


\item Shi, F., Dalrymple, R. A., Kirby, J. T., Chen, Q. and Kennedy, A., 2001, ``A fully nonlinear Boussinesq model in generalized curvilinear coordinates". {\em Coastal Engineering}, {\bf 42}, pp. 337-358.

\item Shiach, J. B. and Mingham, C. G., 2009, ``A temporally second-order accurate Godunov-type scheme for solving the extended Boussinesq equations", {\em Coastal Engineering}, {\bf 56}, 32-45.

\item Sitanggang, K. I. and Lynett, P., 2005, ``Parallel computation of a highly nonlinear Boussinesq equation model through domain
decomposition'', {\em Int. J. Num. Meth. Fluids}, {\bf 49}, 57-74.

\item Smagorinsky, J., 1963, ``General circulation experiments with the primitive equations. I. The basic experiment",  {\em Mon. Weather Rev}, {\bf 91}, 99-165.


\item Swigler, D. and Lynett, P. ,2011, ``Laboratory study of the
three-dimensional turbulence and kinematic properties associated with a
solitary wave traveling over an alongshore-variable, shallow shelf",  in
review.

\item Synolakis, C. E., Bernard, E. N., Titov, V. V., K\^{a}noglu, U. and Gonz\'{a}lez, F. I., 2007, ``Standards, criteria, and procedures for NOAA evaluation of tsunami numerical models'', {\em NOAA Tech. Memo. OAR PMEL-135}, National Oceanic and Atmospheric Administration.

\item Tehranirad, B., Shi, F., Kirby, J. T., Harris, J. C. and Grilli, S., 2011, ``Tsunami benchmark results for fully nonlinear Boussinesq wave model FUNWAVE-TVD, Version 1.0'', Research Report No. CACR-11-02, Center for Applied Coastal Research, University of Delaware.  

\item Ting, F.C.K., Kirby, J.T., 1994, ``Observation of undertow and turbulence in a laboratory surf
zone". {\em Coast. Eng.}  {\bf 24}, 5180.


\item Tonelli, M. and Petti, M., 2009, ``Hybrid finite volume - finite difference scheme for 2DH improved Boussinesq equations'', {\em Coast. Engrng.}, {\bf 56}, 609-620.

\item Tonelli, M. and Petti, M., 2010, ``Finite volume scheme for the solution of 2D extended Boussinesq equations in the surf zone'', {\em Ocean Engrng.}, {\bf 37}, 567-582.

\item Toro, E. F., 2009, {\em Riemann solvers and numerical methods for fluid dynamics: a practical introduction}, Third edition, Springer, New York. 

\item Wei, G., Kirby, J.T., Grilli, S.T., Subramanya, R., 1995,  ``A fully nonlinear Boussinesq model for surface waves: Part I. Highly nonlinear unsteady waves", {\em  Journal of Fluid
Mechanics}  {\bf 294}, 7192.

\item Wei, G. and Kirby, J. T., 1995, ``A time-dependent numerical code for extended Boussinesq equations",  {\em Journal of Waterway, Port, Coastal and Ocean Engineering},  {\bf 120}, pp. 251-261.

\item
Yamamoto, S., Daiguji, H., 1993, ``Higher-order-accurate upwind schemes for solving 
the compressible Euler and NavierStokes equations", {\em Computers and Fluids}, {\bf  22} 
(2/3), 259270. 


\item Yamamoto, S., Kano, S. and Daiguji, H, 1998, ``An efficient CFD approach for simulating unsteady hypersonic shockshock interference flows", {\em Computers and Fluids},  {\bf 27} (56), pp. 571-580. 

\item Zelt, J. A., 1991, ``The runup of nonbreaking and breaking solitary waves",  {\em Coastal Engineering},  {\bf 15}, pp. 205-246.

\item Zhen, F., 2004, ``On the numerical properties of staggered vs. non-staggered grid schemes for a Boussinesq equation model'', MCE Thesis, Department of Civil and Environmental Engineering, University of Delaware.

\item Zhou, J. G., Causon, D. M., Mingham C. G., and Ingram, D. M., 2001, ``The surface gradient method for the treatment of source terms in the shallow-water equations", {\em Journal of Computational Physics}, {\bf 168}, 1-25.

\end{description}

%\begin{figure}[htbp]
%	\centering
%		\includegraphics[width=0.8\textwidth]{../figures/speedup.JPG}
%	\caption{Variation in model performance with number of processors for a 5400 x 3600 domain.  Straight line indicates arithmetic speedup. Actual performance is shown in the curved line.}
%	\label{parallel}
%\end{figure}

\newpage

\section{Appendix A. Expansions of $(U_1^{'},V_1^{'})$, $(U_1^{''},V_1^{''})$, $(U_2,V_2)$, $(U_3,V_3)$ and $(U_4,V_4)$ }

Note that there are typos in the expansion expressions  in both Shi et al. (2012) and the previous manual lower than Version 3.0 (Thanks to Young-Kwang Choi for pointing out the typos and checking the corresponding code). 

The expanded forms of $(U_1^{'},V_1^{'})$, $(U_1^{''},V_1^{''})$, $(U_2,V_2)$, $(U_3,V_3)$ and $(U_4,V_4)$ can be written as

\begin{equation}
U_1^{'}=\frac{1}{2}(1-\beta)^2 h^2 (u_{xx} + v_{xy}) - (1-\beta)h \big[ (hu)_{xx} + (hv)_{xy} \big]
\end{equation}

\begin{equation}
V_1^{'}=\frac{1}{2}(1-\beta)^2 h^2 (u_{xy} + v_{yy}) - (1-\beta)h \big[ (hu)_{xy} + (hv)_{yy} \big]
\end{equation}

\begin{eqnarray}
&&U_1^{''}=-\bigg[
         \eta \eta_x (u_{tx}+v_{ty}) + \frac{1}{2} \eta^2 ( u_{txx}+v_{txy} )
         + \eta_x \Big\{ (hu)_{tx} + (hv)_{ty} \Big\}
         + \eta \Big\{ (hu)_{txx} + (hv)_{txy} \Big\}
          \bigg]
         \nonumber \\
&& \quad \quad \,\,\,
         - \Big[ \beta(1-\beta) h \eta_t - \beta^2 \eta \eta_t \Big] (u_{xx}+v_{xy})
         - \Big[ \beta(1-\beta) h \eta - \frac{1}{2} \beta^2 \eta^2 \Big]
         ( u_{txx} + v_{txy} )
         \nonumber \\
&& \quad \quad \,\,\,
         + \beta \eta_t \Big[ (hu)_{xx} + (hv)_{xy} \Big]
         + \beta \eta \Big[ (hu)_{txx} + (hv)_{txy} \Big]
\end{eqnarray}

\begin{eqnarray}
&&V_1^{''}=-\bigg[
         \eta \eta_y (u_{tx}+v_{ty}) + \frac{1}{2} \eta^2 ( u_{txy}+v_{tyy} )
         + \eta_y \Big\{ (hu)_{tx} + (hv)_{ty} \Big\}
         + \eta \Big\{ (hu)_{txy} + (hv)_{tyy} \Big\}
          \bigg]
         \nonumber \\
&& \quad \quad \,\,\,
         - \Big[ \beta(1-\beta) h \eta_t - \beta^2 \eta \eta_t \Big] (u_{xy}+v_{yy})
         - \Big[ \beta(1-\beta) h \eta - \frac{1}{2} \beta^2 \eta^2 \Big]
         ( u_{txy} + v_{tyy} )
         \nonumber \\
&& \quad \quad \,\,\,
         + \beta \eta_t \Big[ (hu)_{xy} + (hv)_{yy} \Big]
         + \beta \eta \Big[ (hu)_{txy} + (hv)_{tyy} \Big]
\end{eqnarray}

\begin{eqnarray}
&&U_2=\bigg[
        (\beta-1)(h+\eta) \Big\{
        u \big[ (hu)_x + (hv)_y \big]_x +  v \big[ (hu)_x + (hv)_y \big]_y \Big\}
         \nonumber \\
&& \quad \quad
        +\bigg\{ \frac{1}{2} (1-\beta)^2 h^2 - \beta (1-\beta) h \eta + \frac{1}{2} (\beta^2-1) \eta^2 \bigg\}
        \Big\{ u (u_x+v_y)_x + v(u_x+v_y)_y \Big\}   \nonumber  \\
&& \quad \quad
        +\frac{1}{2} \Big\{
        (hu)_x + (hv)_y + \eta (u_x+v_y)
        \Big\}^2
      \bigg]_x
\end{eqnarray}

\begin{eqnarray}
&&V_2=\bigg[
        (\beta-1)(h+\eta) \Big\{
        u \big[ (hu)_x + (hv)_y \big]_x +  v \big[ (hu)_x + (hv)_y \big]_y \Big\}
         \nonumber \\
&& \quad \quad
        +\bigg\{ \frac{1}{2} (1-\beta)^2 h^2 - \beta (1-\beta) h \eta + \frac{1}{2} (\beta^2-1) \eta^2 \bigg\}
        \Big\{ u (u_x+v_y)_x + v(u_x+v_y)_y \Big\}   \nonumber  \\
&& \quad \quad
        +\frac{1}{2} \Big\{
        (hu)_x + (hv)_y + \eta (u_x+v_y)
        \Big\}^2
      \bigg]_y
\end{eqnarray}

\begin{eqnarray}
&&U_3=-v \omega_1 - \omega_0 \bigg[ \Big\{ \big(
      \beta - \frac{1}{2} \big) (h+\eta) \Big\}
      \Big\{ (hu)_x + (hv)_y \Big\}_y   \nonumber \\
&& \quad \quad
      +
      \Big\{
        \big( \frac{1}{3} - \beta + \frac{1}{2} \beta^2 \big) h^2
      + \big( \frac{1}{6} - \beta + \beta^2 \big) \eta h
      + \big( \frac{1}{2} \beta^2 - \frac{1}{6} \big) \eta^2
      \Big\}
      (u_x+v_y)_y
      \bigg]
\end{eqnarray}

\begin{eqnarray}
&&V_3=u \omega_1 + \omega_0 \bigg[ \Big\{ \big(
      \beta - \frac{1}{2} \big) (h+\eta) \Big\}
      \Big\{ (hu)_x + (hv)_y \Big\}_x   \nonumber \\
&& \quad \quad
      +
      \Big\{
        \big( \frac{1}{3} - \beta + \frac{1}{2} \beta^2 \big) h^2
      + \big( \frac{1}{6} - \beta + \beta^2 \big) \eta h
      + \big( \frac{1}{2} \beta^2 - \frac{1}{6} \big) \eta^2
      \Big\}
      (u_x+v_y)_x
      \bigg]
\end{eqnarray}

\begin{eqnarray}
\omega_0 = v_x - u_y
\end{eqnarray}

\begin{eqnarray}
&& \omega_1 = \bigg[ (\beta-1) h_x + \beta \eta_x \bigg]
           \bigg[ \Big\{ (hu)_x + (hv)_y \Big\}_y + \Big\{ (\beta-1)h + \beta \eta \Big\} (u_x+v_y)_y \bigg]   \nonumber  \\
&& \quad \quad
         - \bigg[ (\beta-1) h_y + \beta \eta_y \bigg]
           \bigg[ \Big\{ (hu)_x + (hv)_y \Big\}_x + \Big\{ (\beta-1)h + \beta \eta \Big\} (u_x+v_y)_x \bigg]
\end{eqnarray}

\begin{eqnarray}
&&U_4=\bigg( \frac{1}{3} - \beta + \frac{1}{2} \beta^2 \bigg) h^2 (u_{xx} + v_{xy})
      +
      \bigg( \beta - \frac{1}{2} \bigg) h \Big\{ (hu)_{xx} + (hv)_{xy} \Big\}
      \nonumber   \\
&& \quad \quad
      +
      \bigg[ \Big\{
      \Big(\frac{1}{6} - \beta + \beta^2 \Big) h \eta
      + \Big( \frac{1}{2} \beta^2 - \frac{1}{6} \Big) \eta^2
      \Big\} ( u_{xx}+v_{xy} )
      +
      \bigg( \beta - \frac{1}{2} \bigg) \eta
      \Big\{
      (hu)_{xx}+(hv)_{xy}
      \Big\}
      \bigg]   \nonumber \\
\end{eqnarray}

\begin{eqnarray}
&&V_4=\bigg( \frac{1}{3} - \beta + \frac{1}{2} \beta^2 \bigg) h^2 (u_{xy} + v_{yy})
      +
      \bigg( \beta - \frac{1}{2} \bigg) h \Big\{ (hu)_{xy} + (hv)_{yy} \Big\}
      \nonumber   \\
&& \quad \quad
      +
      \bigg[ \Big\{
      \Big(\frac{1}{6} - \beta + \beta^2 \Big) h \eta
      + \Big( \frac{1}{2} \beta^2 - \frac{1}{6} \Big) \eta^2
      \Big\} ( u_{xy}+v_{yy} )
      +
      \bigg( \beta - \frac{1}{2} \bigg) \eta
      \Big\{
      (hu)_{xy}+(hv)_{yy}
      \Big\}
      \bigg]   \nonumber \\
\end{eqnarray}

\newpage
In detail, 
\begin{eqnarray}
&&U_2=  (\beta-1)(h+\eta)_x \bigg\{
        u \Big[ (hu)_{xx} + (hv)_{yx} \Big] +  v \Big[ (hu)_{xy} + (hv)_{yy} \Big] \bigg\} 
        \nonumber \\
&& \quad \quad
        + (\beta-1)(h+\eta) \bigg\{
        u \Big[ (hu)_{xx} + (hv)_{yx} \Big] +  v \Big[ (hu)_{xy} + (hv)_{yy} \Big] \bigg\}_x
        \nonumber \\        
&& \quad \quad
        +\bigg\{ \frac{1}{2} (1-\beta)^2 h^2 - \beta (1-\beta) h \eta + \frac{1}{2} (\beta^2-1) \eta^2 \bigg\}_x
        \Big\{ u (u_x+v_y)_x + v(u_x+v_y)_y \Big\}   \nonumber  \\
&& \quad \quad
        +\bigg\{ \frac{1}{2} (1-\beta)^2 h^2 - \beta (1-\beta) h \eta + \frac{1}{2} (\beta^2-1) \eta^2 \bigg\}
        \Big\{ u (u_x+v_y)_x + v(u_x+v_y)_y \Big\}_x   \nonumber  \\
&& \quad \quad
        +\Big\{
        (hu)_x + (hv)_y + \eta (u_x+v_y) \Big\}
        \Big\{
        (hu)_x + (hv)_y + \eta (u_x+v_y) \Big\}_x
        \nonumber  \\
        \nonumber  \\
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
&& \quad 
     = (\beta-1)(h_x + \eta_x) \bigg\{
        u \Big[ (hu)_{xx} + (hv)_{yx} \Big] +  v \Big[ (hu)_{xy} + (hv)_{yy} \Big] \bigg\}
        \nonumber \\
&& \quad \quad
        + (\beta-1)(h+\eta) \bigg\{
            u_x \Big[ (hu)_{xx} + (hv)_{yx} \Big]
          + u \Big[ (hu)_{xx} + (hv)_{yx} \Big]_x
        \nonumber \\
&& \quad \quad \quad \quad \quad \quad \quad \quad 
   \quad \quad \quad \quad \quad \quad \quad \quad 
          + v_x \Big[ (hu)_{xy} + (hv)_{yy} \Big]
          + v \Big[ (hu)_{xy} + (hv)_{yy} \Big]_x
                            \bigg\}
        \nonumber \\
&& \quad \quad
       +\bigg\{ 
       (1-\beta)^2 h h_x - \beta (1-\beta) (h_x \eta + h \eta_x) + (\beta^2-1) \eta \eta_x
        \bigg\} 
        \bigg\{ u ( u_{xx} + v_{yx} ) 
        \nonumber \\
&& \quad \quad \quad \quad \quad \quad \quad \quad 
   \quad \quad \quad \quad \quad \quad \quad \quad
        + v ( u_{xy} + v_{yy} ) \bigg\}
        \nonumber \\
&& \quad \quad
        +\bigg\{ \frac{1}{2} (1-\beta)^2 h^2 - \beta (1-\beta) h \eta + \frac{1}{2} (\beta^2-1) \eta^2 \bigg\}
        \bigg\{ u_x ( u_{xx} + v_{yx} ) + u ( u_{xx} + v_{yx} )_x
        \nonumber \\
&& \quad \quad \quad \quad \quad \quad \quad \quad
   \quad \quad \quad \quad \quad \quad \quad \quad
        + v_x ( u_{xy} + v_{yy} ) + v ( u_{xy} + v_{yy} )_x
        \bigg\}
        \nonumber \\
&& \quad \quad        
        +\Big\{
        (hu)_x + (hv)_y + \eta (u_x+v_y) \Big\}
        \Big\{
        (hu)_{xx} + (hv)_{yx} + \eta_x (u_x+v_y) + \eta (u_{xx}+v_{yx}) \Big\}
        \nonumber \\
\end{eqnarray}

\newpage
\begin{eqnarray}
&&V_2=  (\beta-1)(h+\eta)_y \bigg\{
        u \Big[ (hu)_{xx} + (hv)_{yx} \Big] +  v \Big[ (hu)_{xy} + (hv)_{yy} \Big] \bigg\}
        \nonumber \\
&& \quad \quad
        + (\beta-1)(h+\eta) \bigg\{
        u \Big[ (hu)_{xx} + (hv)_{yx} \Big] +  v \Big[ (hu)_{xy} + (hv)_{yy} \Big] \bigg\}_y
        \nonumber \\
&& \quad \quad
        +\bigg\{ \frac{1}{2} (1-\beta)^2 h^2 - \beta (1-\beta) h \eta + \frac{1}{2} (\beta^2-1) \eta^2 \bigg\}_y
        \Big\{ u ( u_{xx} + v_{yx} ) + v ( u_{xy} + v_{yy} ) \Big\}   \nonumber  \\
&& \quad \quad
        +\bigg\{ \frac{1}{2} (1-\beta)^2 h^2 - \beta (1-\beta) h \eta + \frac{1}{2} (\beta^2-1) \eta^2 \bigg\}
        \Big\{ u ( u_{xx} + v_{yx} ) + v ( u_{xy} + v_{yy} ) \Big\}_y   \nonumber  \\
&& \quad \quad
        +\Big\{
        (hu)_x + (hv)_y + \eta (u_x+v_y) \Big\}
        \Big\{
        (hu)_x + (hv)_y + \eta (u_x+v_y) \Big\}_y
        \nonumber  \\
        \nonumber  \\
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
&& \quad
     = (\beta-1)(h_y + \eta_y) \bigg\{
        u \Big[ (hu)_{xx} + (hv)_{yx} \Big] +  v \Big[ (hu)_{xy} + (hv)_{yy} \Big] \bigg\}
        \nonumber \\
&& \quad \quad
        + (\beta-1)(h+\eta) \bigg\{
            u_y \Big[ (hu)_{xx} + (hv)_{yx} \Big]
          + u \Big[ (hu)_{xx} + (hv)_{yx} \Big]_y
        \nonumber \\
&& \quad \quad \quad \quad \quad \quad \quad \quad
   \quad \quad \quad \quad \quad \quad \quad \quad
          + v_y \Big[ (hu)_{xy} + (hv)_{yy} \Big]
          + v \Big[ (hu)_{xy} + (hv)_{yy} \Big]_y
                            \bigg\}
        \nonumber \\
&& \quad \quad
       +\bigg\{
       (1-\beta)^2 h h_y - \beta (1-\beta) (h_y \eta + h \eta_y) + (\beta^2-1) \eta \eta_y
        \bigg\}
        \bigg\{ u ( u_{xx} + v_{yx} )
        \nonumber \\
&& \quad \quad \quad \quad \quad \quad \quad \quad
   \quad \quad \quad \quad \quad \quad \quad \quad
        + v ( u_{xy} + v_{yy} ) \bigg\}
        \nonumber \\
&& \quad \quad
        +\bigg\{ \frac{1}{2} (1-\beta)^2 h^2 - \beta (1-\beta) h \eta + \frac{1}{2} (\beta^2-1) \eta^2 \bigg\}
        \bigg\{ u_y ( u_{xx} + v_{yx} ) + u ( u_{xx} + v_{yx} )_y
        \nonumber \\
&& \quad \quad \quad \quad \quad \quad \quad \quad
   \quad \quad \quad \quad \quad \quad \quad \quad
        + v_y ( u_{xy} + v_{yy} ) + v ( u_{xy} + v_{yy} )_y
        \bigg\}
        \nonumber \\
&& \quad \quad
        +\Big\{
        (hu)_x + (hv)_y + \eta (u_x+v_y) \Big\}
        \Big\{
        (hu)_{xy} + (hv)_{yy} + \eta_y (u_x+v_y) + \eta (u_{xy}+v_{yy}) \Big\}
        \nonumber \\
\end{eqnarray}



\end{document}  